<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:22.0141991"><meta name="build-number" content="${buildNumber}">       <title>ZooKeeper backup | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"zookeeper-backup-linktitle-zookeeper-backup-description-zookeeper-backup","level":0,"title":"#ZooKeeper backup\nlinkTitle: \"ZooKeeper backup\"\ndescription: \u003e\nZooKeeper backup","anchor":"#zookeeper-backup-linktitle-zookeeper-backup-description-zookeeper-backup"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="ZooKeeper backup | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/kb-zookeeper-backup.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="ZooKeeper backup | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/kb-zookeeper-backup.html#webpage", "url": "/1.0/kb-zookeeper-backup.html", "name": "ZooKeeper backup | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-zookeeper-backup" data-main-title="ZooKeeper backup" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance///kb-zookeeper"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-zookeeper-backup"   id="kb-zookeeper-backup.md">ZooKeeper backup</h1>  <section class="chapter"><h2 id="zookeeper-backup-linktitle-zookeeper-backup-description-zookeeper-backup" data-toc="zookeeper-backup-linktitle-zookeeper-backup-description-zookeeper-backup"   >#ZooKeeper backup
linkTitle: &quot;ZooKeeper backup&quot;
description: &gt;
ZooKeeper backup</h2><p id="194a4c7e_92">Question: Do I need to backup Zookeeper Database, because it&rsquo;s pretty important for ClickHouse?</p><p id="194a4c7e_93">TLDR answer: <span class="control" id="194a4c7e_94">NO, just backup ClickHouse data itself, and do SYSTEM RESTORE REPLICA during recovery to recreate zookeeper data</span></p><p id="194a4c7e_95">Details:</p><p id="194a4c7e_96">Zookeeper does not store any data, it stores the STATE of the distributed system (&quot;that replica have those parts&quot;, &quot;still need 2 merges to do&quot;, &quot;alter is being applied&quot; etc). That state always changes, and you can not capture / backup / and recover that state in a safe manner. So even backup from few seconds ago is represending some 'old state from the past' which is INCONSISTENT with actual state of the data.</p><p id="194a4c7e_97">In other words - if clickhouse is working - then the state of distributed system always changes, and it's almost impossible to collect the current state of zookeeper (while you collecting it it will change many times). The only exception is 'stop-the-world' scenario - i.e. shutdown all clickhouse nodes, with all other zookeeper clients, then shutdown all the zookeeper, and only then take the backups, in that scenario and backups of zookeeper &amp; clickhouse will be consistent. In that case restoring the backup is as simple (and is equal to) as starting all the nodes which was stopped before. But usually that scenario is very non-practical because it requires huge downtime.</p><p id="194a4c7e_98">So what to do instead? It's enought if you will backup clickhouse data itself, and to recover the state of zookeeper you can just run the command <code class="code" id="194a4c7e_99">SYSTEM RESTORE REPLICA</code> command <span class="control" id="194a4c7e_100">AFTER</span> restoring the clickhouse data itself. That will recreate the state of the replica in the zookeeper as it exists on the filesystem after backup recovery.</p><p id="194a4c7e_101">Normally Zookeeper ensemble consists of 3 nodes, which is enough to survive hardware failures.</p><p id="194a4c7e_102">On older verion (which don't have <code class="code" id="194a4c7e_103">SYSTEM RESTORE REPLICA</code> command - it can be done manually, using instruction https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replication/#converting-from-mergetree-to-replicatedmergetree), on scale you can try <a href="https://github.com/Robin/clickhouse-zookeeper-recovery" id="194a4c7e_104"   data-external="true" rel="noopener noreferrer" >https://github.com/Robin/clickhouse-zookeeper-recovery</a></p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-zookeeper-cluster-migration.html">ZooKeeper cluster migration</a>   <a class="navigation-links__next" href="kb-recovering-from-complete-metadata-loss-in-zookeeper.html">Recovering from complete metadata loss in ZooKeeper</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>