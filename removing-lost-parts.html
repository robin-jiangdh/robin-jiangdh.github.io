<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:46.2751957"><meta name="build-number" content="${buildNumber}">       <title>Removing lost parts | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"removing-lost-parts-linktitle-removing-lost-parts-description-removing-lost-parts","level":0,"title":"#Removing lost parts\nlinkTitle: \"Removing lost parts\"\ndescription: \u003e\nRemoving lost parts","anchor":"#removing-lost-parts-linktitle-removing-lost-parts-description-removing-lost-parts"},{"id":"there-might-be-parts-left-in-zookeeper-that-don-t-exist-on-disk","level":0,"title":"There might be parts left in ZooKeeper that don\u0027t exist on disk","anchor":"#there-might-be-parts-left-in-zookeeper-that-don-t-exist-on-disk"},{"id":"regarding-the-procedure-to-reproduce-the-issue","level":0,"title":"Regarding the procedure to reproduce the issue:","anchor":"#regarding-the-procedure-to-reproduce-the-issue"},{"id":"a-query-to-find-forgotten-parts","level":0,"title":"A query to find \u0027forgotten\u0027 parts","anchor":"#a-query-to-find-forgotten-parts"},{"id":"a-query-to-drop-empty-partitions-with-failing-replication-tasks","level":0,"title":"A query to drop empty partitions with failing replication tasks","anchor":"#a-query-to-drop-empty-partitions-with-failing-replication-tasks"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Removing lost parts | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/removing-lost-parts.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Removing lost parts | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/removing-lost-parts.html#webpage", "url": "/blog/1.0/removing-lost-parts.html", "name": "Removing lost parts | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="removing-lost-parts" data-main-title="Removing lost parts" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///upgrade"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="removing-lost-parts"   id="removing-lost-parts.md">Removing lost parts</h1>  <section class="chapter"><h2 id="removing-lost-parts-linktitle-removing-lost-parts-description-removing-lost-parts" data-toc="removing-lost-parts-linktitle-removing-lost-parts-description-removing-lost-parts"   >#Removing lost parts
linkTitle: &quot;Removing lost parts&quot;
description: &gt;
Removing lost parts</h2></section><section class="chapter"><h2 id="there-might-be-parts-left-in-zookeeper-that-don-t-exist-on-disk" data-toc="there-might-be-parts-left-in-zookeeper-that-don-t-exist-on-disk"   >There might be parts left in ZooKeeper that don't exist on disk</h2><p id="44a6a875_343">The explanation is here https://github.com/ClickHouse/ClickHouse/pull/26716</p><p id="44a6a875_344">The problem is introduced in 20.1.</p><p id="44a6a875_345">The problem is fixed in 21.8 and backported to 21.3.16, 21.6.9, 21.7.6.</p></section><section class="chapter"><h2 id="regarding-the-procedure-to-reproduce-the-issue" data-toc="regarding-the-procedure-to-reproduce-the-issue"   >Regarding the procedure to reproduce the issue:</h2><p id="44a6a875_346">The procedure was not confirmed, but I think it should work.</p><ol class="list _decimal" id="44a6a875_347" type="1"><li class="list__item" id="44a6a875_348"><p id="44a6a875_349">Wait for a merge on a particular partition (or run an OPTIMIZE to trigger one) At this point you can collect the names of parts participating in the merge from the system.merges table, or the system.parts table.</p></li><li class="list__item" id="44a6a875_350"><p id="44a6a875_351">When the merge finishes, stop one of the replicas before the inactive parts are dropped (or detach the table).</p></li><li class="list__item" id="44a6a875_352"><p id="44a6a875_353">Bring the replica back up (or attach the table). Check that there are no inactive parts in system.parts, but they stayed in ZooKeeper. Also check that the inactive parts got removed from ZooKeeper for another replica. Here is the query to check ZooKeeper:</p></li></ol><div class="code-block" data-lang="none"         >
select name, ctime from system.zookeeper
where path='&lt;table_zpath&gt;/replicas/&lt;replica_name&gt;/parts/'
  and name like '&lt;put an expression for the parts that were merged&gt;'
</div><ol class="list _decimal" id="44a6a875_355" type="1" start="4"><li class="list__item" id="44a6a875_356"><p>Drop the partition on the replica that DOES NOT have those extra parts in ZooKeeper. Check the list of parts in ZooKeeper. We hope that after this the parts on disk will be removed on all replicas, but one of the replicas will still have some parts left in ZooKeeper. If this happens, then we think that after a restart of the replica with extra parts in ZooKeeper it will try to download them from another replica.</p></li></ol></section><section class="chapter"><h2 id="a-query-to-find-forgotten-parts" data-toc="a-query-to-find-forgotten-parts"   >A query to find 'forgotten' parts</h2><p id="44a6a875_357">https://kb.Robinjiang.com/kb-useful-queries/parts-consistency/#compare-the-list-of-parts-in-zookeeper-with-the-list-of-parts-on-disk</p></section><section class="chapter"><h2 id="a-query-to-drop-empty-partitions-with-failing-replication-tasks" data-toc="a-query-to-drop-empty-partitions-with-failing-replication-tasks"   >A query to drop empty partitions with failing replication tasks</h2><div class="code-block" data-lang="none"         >
select 'alter table '||database||'.'||table||' drop partition id '''||partition_id||''';' 
from (
select database, table, splitByChar('_',new_part_name)[1] partition_id
from system.replication_queue
where type='GET_PART' and not is_currently_executing and create_time &lt; toStartOfDay(yesterday())
group by database, table, partition_id) q
left join 
(select database, table, partition_id, countIf(active) cnt_active, count() cnt_total
from system.parts group by  database, table, partition_id
) p using database, table, partition_id
where cnt_active=0
</div></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="upgrade-clickhouse-feature-report.html">Clickhouse Function/Engines/Settings Report</a>   <a class="navigation-links__next" href="removing-empty-parts.html">Removing empty parts</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>