<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.6422805"><meta name="build-number" content="${buildNumber}">       <title>High CPU usage | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"high-cpu-usage-linktitle-high-cpu-usage-description-high-cpu-usage","level":0,"title":"#High CPU usage\nlinkTitle: \"High CPU usage\"\ndescription: \u003e\nHigh CPU usage","anchor":"#high-cpu-usage-linktitle-high-cpu-usage-description-high-cpu-usage"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="High CPU usage | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/kb-setup-and-maintenance-high-cpu-usage.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="High CPU usage | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/kb-setup-and-maintenance-high-cpu-usage.html#webpage", "url": "/blog/1.0/kb-setup-and-maintenance-high-cpu-usage.html", "name": "High CPU usage | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-setup-and-maintenance_high-cpu-usage" data-main-title="High CPU usage" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-setup-and-maintenance_high-cpu-usage"   id="kb-setup-and-maintenance_high-cpu-usage.md">High CPU usage</h1>  <section class="chapter"><h2 id="high-cpu-usage-linktitle-high-cpu-usage-description-high-cpu-usage" data-toc="high-cpu-usage-linktitle-high-cpu-usage-description-high-cpu-usage"   >#High CPU usage
linkTitle: &quot;High CPU usage&quot;
description: &gt;
High CPU usage</h2><p id="e58392c0_271">In general, it is a NORMAL situation for clickhouse that while processing a huge dataset it can use a lot of (or all of) the server resources. It is 'by design' - just to make the answers faster.</p><p id="e58392c0_272">The main directions to reduce the CPU usage <span class="control" id="e58392c0_273">is to review the schema / queries</span> to limit the amount of the data which need to be processed, and to plan the resources in a way when single running query will not impact the others.</p><p id="e58392c0_274">Any attempts to reduce the CPU usage will end up with slower queries!</p><section class="chapter"><h3 id="how-to-slow-down-queries-to-reduce-the-cpu-usage" data-toc="how-to-slow-down-queries-to-reduce-the-cpu-usage"   >How to slow down queries to reduce the CPU usage</h3><p id="e58392c0_275">If it is acceptable for you - please check the following options for limiting the CPU usage:</p><ol class="list _decimal" id="e58392c0_276" type="1"><li class="list__item" id="e58392c0_277"><p id="e58392c0_278">setting <code class="code" id="e58392c0_279">max_threads</code>: reducing the number of threads that are allowed to use one request. Fewer threads = more free cores for other requests. By default, it's allowed to take half of the available CPU cores, adjust only when needed. So if if you have 10 cores then <code class="code" id="e58392c0_280">max_threads = 10</code> will work about twice faster than <code class="code" id="e58392c0_281">max_threads=5</code>, but will take 100% or CPU. (max_threads=5 will use half of CPUs so 50%).</p></li><li class="list__item" id="e58392c0_282"><p id="e58392c0_283">setting <code class="code" id="e58392c0_284">os_thread_priority</code>: increasing niceness for selected requests. In this case, the operating system, when choosing which of the running processes to allocate processor time, will prefer processes with lower niceness. 0 is the default niceness. The higher the niceness, the lower the priority of the process. The maximum niceness value is 19.</p></li></ol><p id="e58392c0_285">These are custom settings that can be tweaked in several ways:</p><ol class="list _decimal" id="e58392c0_286" type="1"><li class="list__item" id="e58392c0_287"><p id="e58392c0_288">by specifying them when connecting a client, for example</p><div class="code-block" data-lang="none"         >
clickhouse-client --os_thread_priority=19 -q 'SELECT max (number) from numbers (100000000)'

echo 'SELECT max(number) from numbers(100000000)' | curl 'http://localhost:8123/?os_thread_priority=19' --data-binary @-
</div></li><li class="list__item" id="e58392c0_290"><p id="e58392c0_291">via dedicated API / connection parameters in client libraries</p></li><li class="list__item" id="e58392c0_292"><p id="e58392c0_293">using the SQL command SET (works only within the session)</p><div class="code-block" data-lang="none"         >
SET os_thread_priority = 19;
SELECT max(number) from numbers(100000000)
</div></li><li class="list__item" id="e58392c0_295"><p id="e58392c0_296">using different profiles of settings for different users. Something like</p><div class="code-block" data-lang="none"         >
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;yandex&gt;
    &lt;profiles&gt;
        &lt;default&gt;
        ...
        &lt;/default&gt;

        &lt;lowcpu&gt;
            &lt;os_thread_priority&gt;19&lt;/os_thread_priority&gt;
            &lt;max_threads&gt;4&lt;/max_threads&gt;
        &lt;/lowcpu&gt;
    &lt;/profiles&gt;

    &lt;!-- Users and ACL. --&gt;
    &lt;users&gt;
        &lt;!-- If user name was not specified, 'default' user is used. --&gt;
        &lt;limited_user&gt;
            &lt;password&gt;123&lt;/password&gt;
            &lt;networks&gt;
                &lt;ip&gt;::/0&lt;/ip&gt;
            &lt;/networks&gt;
            &lt;profile&gt;lowcpu&lt;/profile&gt;

            &lt;!-- Quota for user. --&gt;
            &lt;quota&gt;default&lt;/quota&gt;
        &lt;/limited_user&gt;
    &lt;/users&gt;

&lt;/yandex&gt;
</div></li></ol><p id="e58392c0_298">There are also plans to introduce a system of more flexible control over the assignment of resources to different requests.</p><p id="e58392c0_299">Also, if these are manually created queries, then you can try to discipline users by adding quotas to them (they can be formulated as &quot;you can read no more than 100GB of data per hour&quot; or &quot;no more than 10 queries&quot;, etc.)</p><p id="e58392c0_300">If these are automatically generated queries, it may make sense to check if there is no way to write them in a more efficient way.</p></section></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-setup-and-maintenance-http-handlers.html">http handler example</a>   <a class="navigation-links__next" href="kb-setup-and-maintenance-filesystems.html">ClickHouse and different filesystems</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>