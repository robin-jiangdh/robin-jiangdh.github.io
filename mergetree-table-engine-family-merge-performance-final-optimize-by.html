<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.2664326"><meta name="build-number" content="${buildNumber}">       <title>Merge performance and OPTIMIZE FINAL | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"merge-performance-and-optimize-final-linktitle-merge-performance-and-optimize-final-description-merge-performance-and-optimize-final-deduplicate-by-expr","level":0,"title":"#Merge performance and OPTIMIZE FINAL\nlinkTitle: \"Merge performance and OPTIMIZE FINAL\"\ndescription: \u003e\nMerge performance and OPTIMIZE FINAL DEDUPLICATE BY expr","anchor":"#merge-performance-and-optimize-final-linktitle-merge-performance-and-optimize-final-description-merge-performance-and-optimize-final-deduplicate-by-expr"},{"id":"merge-performance","level":0,"title":"Merge Performance","anchor":"#merge-performance"},{"id":"optimize-table-example-final-deduplicate-by-expr","level":0,"title":"OPTIMIZE TABLE example FINAL DEDUPLICATE BY expr","anchor":"#optimize-table-example-final-deduplicate-by-expr"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Merge performance and OPTIMIZE FINAL | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/mergetree-table-engine-family-merge-performance-final-optimize-by.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Merge performance and OPTIMIZE FINAL | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/mergetree-table-engine-family-merge-performance-final-optimize-by.html#webpage", "url": "/blog/1.0/mergetree-table-engine-family-merge-performance-final-optimize-by.html", "name": "Merge performance and OPTIMIZE FINAL | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="mergetree-table-engine-family_merge-performance-final-optimize-by" data-main-title="Merge performance and OPTIMIZE FINAL" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///engines///mergetree-table-engine-family"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="mergetree-table-engine-family_merge-performance-final-optimize-by"   id="mergetree-table-engine-family_merge-performance-final-optimize-by.md">Merge performance and OPTIMIZE FINAL</h1>  <section class="chapter"><h2 id="merge-performance-and-optimize-final-linktitle-merge-performance-and-optimize-final-description-merge-performance-and-optimize-final-deduplicate-by-expr" data-toc="merge-performance-and-optimize-final-linktitle-merge-performance-and-optimize-final-description-merge-performance-and-optimize-final-deduplicate-by-expr"   >#Merge performance and OPTIMIZE FINAL
linkTitle: &quot;Merge performance and OPTIMIZE FINAL&quot;
description: &gt;
Merge performance and OPTIMIZE FINAL DEDUPLICATE BY expr</h2></section><section class="chapter"><h2 id="merge-performance" data-toc="merge-performance"   >Merge Performance</h2><p id="36571f1c_244">Main things affecting the merge speed are:</p><ul class="list _ul" id="36571f1c_245"><li class="list__item" id="36571f1c_246"><p>Schema (especially compression codecs, some bad types, sorting order...)</p></li><li class="list__item" id="36571f1c_247"><p>Horizontal vs Vertical merge </p><ul class="list _ul" id="36571f1c_248"><li class="list__item" id="36571f1c_249"><p>Horizontal = reads all columns at once, do merge sort, write new part</p></li><li class="list__item" id="36571f1c_250"><p>Vertical = first read columns from order by, do merge sort, write them to disk, remember permutation, then process the rest of columns on by one, applying permutation.</p></li></ul></li><li class="list__item" id="36571f1c_251"><p>compact vs wide parts</p></li><li class="list__item" id="36571f1c_252"><p>Other things like server load, concurrent merges...</p></li></ul><div class="code-block" data-lang="none"         >
SELECT name, value
FROM system.merge_tree_settings
WHERE name LIKE '%vert%';

│ enable_vertical_merge_algorithm&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; │ 1&nbsp; &nbsp; &nbsp; 
│ vertical_merge_algorithm_min_rows_to_activate&nbsp; &nbsp; │ 131072
│ vertical_merge_algorithm_min_columns_to_activate │ 11
</div><ul class="list _ul" id="36571f1c_254"><li class="list__item" id="36571f1c_255"><p><span class="control" id="36571f1c_256">Vertical merge</span> will be used if part has more than 131072 rows and more than 11 columns in the table.</p></li></ul><div class="code-block" data-lang="none"         >
-- Disable Vertical Merges
ALTER TABLE test MODIFY SETTING enable_vertical_merge_algorithm = 0
</div><ul class="list _ul" id="36571f1c_258"><li class="list__item" id="36571f1c_259"><p><span class="control" id="36571f1c_260">Horizontal merge</span> used by default, will use more memory if there are more than 80 columns in the table</p></li></ul></section><section class="chapter"><h2 id="optimize-table-example-final-deduplicate-by-expr" data-toc="optimize-table-example-final-deduplicate-by-expr"   >OPTIMIZE TABLE example FINAL DEDUPLICATE BY expr</h2><p id="36571f1c_261">When using deduplicate feature in <code class="code" id="36571f1c_262">OPTIMIZE FINAL</code>, the question is which row will remain and won't be deduped?</p><p id="36571f1c_263">For SELECT operations Clickhouse does not guarantee the order of the resultset unless you specify ORDER BY. This random ordering is affected by different parameters, like for example <code class="code" id="36571f1c_264">max_threads</code>.</p><p id="36571f1c_265">In a merge operation ClickHouse reads rows sequentially in storage order, which is determined by ORDER BY specified in CREATE TABLE statement, and only the first unique row in that order survives deduplication. So it is a bit different from how SELECT actually works. As FINAL clause is used then ClickHouse will merge all rows across all partitions (If it is not specified then the merge operation will be done per partition), and so the first unique row of the first partition will survive deduplication. Merges are single-threaded because it is too complicated to apply merge ops in-parallel, and it generally makes no sense.</p><ul class="list _ul" id="36571f1c_266"><li class="list__item" id="36571f1c_267"><p><a href="https://github.com/ClickHouse/ClickHouse/pull/17846" id="36571f1c_268"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/pull/17846</a></p></li><li class="list__item" id="36571f1c_269"><p><a href="https://clickhouse.com/docs/en/sql-reference/statements/optimize/" id="36571f1c_270"   data-external="true" rel="noopener noreferrer" >https://clickhouse.com/docs/en/sql-reference/statements/optimize/</a></p></li></ul></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="mergetree-table-engine-family-mergetree-table-engine-family-index.html">MergeTree table engine family</a>   <a class="navigation-links__next" href="mergetree-table-engine-family-kb-nulls-in-order-by.html">Nulls in order by</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>