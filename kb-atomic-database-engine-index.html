<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:46.8102167"><meta name="build-number" content="${buildNumber}">       <title>Atomic Database Engine | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"atomic-database-engine-atomic-database-engine-linktitle-atomic-database-engine-description-atomic-database-engine","level":0,"title":"#Atomic Database Engine\n#Atomic Database Engine\nlinkTitle: \"Atomic Database Engine\"\ndescription: \u003e\nAtomic Database Engine","anchor":"#atomic-database-engine-atomic-database-engine-linktitle-atomic-database-engine-description-atomic-database-engine"},{"id":"faq","level":0,"title":"FAQ","anchor":"#faq"},{"id":"using-ordinary-by-default-instead-of-atomic","level":0,"title":"Using Ordinary by default instead of Atomic","anchor":"#using-ordinary-by-default-instead-of-atomic"},{"id":"other-sources","level":0,"title":"Other sources","anchor":"#other-sources"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Atomic Database Engine | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/kb-atomic-database-engine-index.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Atomic Database Engine | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/kb-atomic-database-engine-index.html#webpage", "url": "/blog/1.0/kb-atomic-database-engine-index.html", "name": "Atomic Database Engine | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-atomic-database-engine_index" data-main-title="Atomic Database Engine" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///engines///kb-atomic-database-engine"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-atomic-database-engine_index"   id="kb-atomic-database-engine_index.md">Atomic Database Engine</h1>  <section class="chapter"><h2 id="atomic-database-engine-atomic-database-engine-linktitle-atomic-database-engine-description-atomic-database-engine" data-toc="atomic-database-engine-atomic-database-engine-linktitle-atomic-database-engine-description-atomic-database-engine"   >#Atomic Database Engine
#Atomic Database Engine
linkTitle: &quot;Atomic Database Engine&quot;
description: &gt;
Atomic Database Engine</h2><p id="bb6553dd_830">In version 20.5 ClickHouse first introduced database engine=Atomic.</p><p id="bb6553dd_831">Since version 20.10 it is a default database engine (before engine=Ordinary was used).</p><p id="bb6553dd_832">Those 2 database engine differs in a way how they store data on a filesystem, and engine Atomic allows to resolve some of the issues existed in engine=Ordinary.</p><p id="bb6553dd_833">engine=Atomic supports</p><ul class="list _ul" id="bb6553dd_834"><li class="list__item" id="bb6553dd_835"><p>non-blocking drop table / rename table</p></li><li class="list__item" id="bb6553dd_836"><p>tables delete (&amp;detach) async (wait for selects finish but invisible for new selects)</p></li><li class="list__item" id="bb6553dd_837"><p>atomic drop table (all files / folders removed)</p></li><li class="list__item" id="bb6553dd_838"><p>atomic table swap (table swap by &quot;EXCHANGE TABLES t1 AND t2;&quot;)</p></li><li class="list__item" id="bb6553dd_839"><p>rename dictionary / rename database</p></li><li class="list__item" id="bb6553dd_840"><p>unique automatic UUID paths in FS and ZK for Replicated</p></li></ul></section><section class="chapter"><h2 id="faq" data-toc="faq"   >FAQ</h2><section class="chapter"><h3 id="q-data-is-not-removed-immediately" data-toc="q-data-is-not-removed-immediately"   >Q. Data is not removed immediately</h3><p id="bb6553dd_841">A. Use<code class="code" id="bb6553dd_842">DROP TABLE t SYNC;</code></p><p id="bb6553dd_843">Or use parameter (user level) database_atomic_wait_for_drop_and_detach_synchronously<code class="code" id="bb6553dd_844">:</code></p><div class="code-block" data-lang="none"         >
SET database_atomic_wait_for_drop_and_detach_synchronously = 1;
</div><p id="bb6553dd_846">Also, you can decrease the delay used by Atomic for real table drop (it&rsquo;s 8 minutes by default)</p><div class="code-block" data-lang="none"         >
cat /etc/clickhouse-server/config.d/database_atomic_delay_before_drop_table.xml
&lt;clickhouse&gt;
    &lt;database_atomic_delay_before_drop_table_sec&gt;1&lt;/database_atomic_delay_before_drop_table_sec&gt;
&lt;/clickhouse&gt;
</div></section><section class="chapter"><h3 id="q-i-cannot-reuse-zookeeper-path-after-dropping-the-table" data-toc="q-i-cannot-reuse-zookeeper-path-after-dropping-the-table"   >Q. I cannot reuse zookeeper path after dropping the table.</h3><p id="bb6553dd_848">A. This happens because real table deletion occurs with a controlled delay. See the previous question to remove the table immediately.</p><p id="bb6553dd_849">With engine=Atomic it&rsquo;s possible (and is a good practice if you do it correctly) to include UUID into zookeeper path, i.e. :</p><div class="code-block" data-lang="none"         >
CREATE ...
ON CLUSTER ...
ENGINE=ReplicatedMergeTree('/clickhouse/tables/{uuid}/{shard}/', '{replica}')
</div><p id="bb6553dd_851">See also: <a href="https://github.com/ClickHouse/ClickHouse/issues/12135#issuecomment-653932557" id="bb6553dd_852"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/issues/12135#issuecomment-653932557</a></p><p id="bb6553dd_853">It&rsquo;s very important that the table will have the same UUID cluster-wide.</p><p id="bb6553dd_854">When the table is created using <span class="emphasis" id="bb6553dd_855">ON CLUSTER</span> - all tables will get the same UUID automatically. When it needs to be done manually (for example - you need to add one more replica), pick CREATE TABLE statement with UUID from one of the existing replicas.</p><div class="code-block" data-lang="none"         >
set show_table_uuid_in_table_create_qquery_if_not_nil=1　;
SHOW CREATE TABLE xxx; /* or SELECT create_table_query FROM system.tables WHERE ... */
</div></section><section class="chapter"><h3 id="q-should-i-use-atomic-or-ordinary-for-new-setups" data-toc="q-should-i-use-atomic-or-ordinary-for-new-setups"   >Q. Should I use Atomic or Ordinary for new setups?</h3><p id="bb6553dd_857">All things inside clickhouse itself should work smoothly with <code class="code" id="bb6553dd_858">Atomic</code>.</p><p id="bb6553dd_859">But some external tools - backup tools, things involving other kinds of direct manipulations with clickhouse files &amp; folders may have issues with <code class="code" id="bb6553dd_860">Atomic</code>.</p><p id="bb6553dd_861"><code class="code" id="bb6553dd_862">Ordinary</code> layout on the filesystem is simpler. And the issues which address Atomic (lock-free renames, drops, atomic exchange of table) are not so critical in most cases.</p><div class="table-wrapper"><table class="wide" id="bb6553dd_863"><thead><tr class="ijRowHead" id="bb6553dd_864"><th id="bb6553dd_865"></th><th id="bb6553dd_866"><p>Ordinary</p></th><th id="bb6553dd_867"><p>Atomic</p></th></tr></thead><tbody><tr id="bb6553dd_868"><td id="bb6553dd_869"><p>filesystem layout</p></td><td id="bb6553dd_870"><p>very simple</p></td><td id="bb6553dd_871"><p>more complicated</p></td></tr><tr id="bb6553dd_872"><td id="bb6553dd_873"><p>external tool support </p><br><p> (like clickhouse-backup)</p></td><td id="bb6553dd_875"><p>good / mature</p></td><td id="bb6553dd_876"><p>limited / beta</p></td></tr><tr id="bb6553dd_877"><td id="bb6553dd_878"><p id="bb6553dd_879">some DDL queries (DROP / RENAME) may</p><p id="bb6553dd_880">hang for a long time (waiting for some other things)</p></td><td id="bb6553dd_881"><p>yes &amp;#x1F44E;</p></td><td id="bb6553dd_882"><p>no &amp;#x1F44D;</p></td></tr><tr id="bb6553dd_883"><td id="bb6553dd_884"><p>Possibility to swap 2 tables</p></td><td id="bb6553dd_885"><p id="bb6553dd_886">rename <br> a to a_old, <br> b to a,</p><p id="bb6553dd_889">a_old to b;</p><p id="bb6553dd_890">Operation is not atomic, and <br> can break in the middle (while chances are low).</p></td><td id="bb6553dd_892"><p id="bb6553dd_893"></p><p id="bb6553dd_894">EXCHANGE TABLES t1 AND t2</p><p id="bb6553dd_895">Atomic, have no intermediate states.</p></td></tr><tr id="bb6553dd_896"><td id="bb6553dd_897"><p>uuid in zookeeper path</p></td><td id="bb6553dd_898"><p id="bb6553dd_899">Not possible to use.</p><p id="bb6553dd_900">The typical pattern is to add version suffix to zookeeper path when you need to create <br> the new version of the same table.</p></td><td id="bb6553dd_902"><p id="bb6553dd_903">You can use uuid in zookeeper paths. <br> That requires some extra care when you expand the cluster, and makes zookeeper paths harder to map to real table.</p><p id="bb6553dd_905">But allows to to do any kind of manipulations on tables (rename, recreate with same name etc).</p></td></tr><tr id="bb6553dd_906"><td id="bb6553dd_907"><p id="bb6553dd_908">Materialized view without TO syntax</p><p id="bb6553dd_909">(!we recommend using TO syntax always!)</p></td><td id="bb6553dd_910"><p id="bb6553dd_911">.inner.mv_name</p><p id="bb6553dd_912">The name is predictable, easy to match with MV.</p></td><td id="bb6553dd_913"><p id="bb6553dd_914">.inner_id.{uuid}</p><p id="bb6553dd_915">The name is unpredictable, hard to match with MV (maybe problematic for MV chains, and similar scenarios)</p></td></tr></tbody></table></div></section></section><section class="chapter"><h2 id="using-ordinary-by-default-instead-of-atomic" data-toc="using-ordinary-by-default-instead-of-atomic"   >Using Ordinary by default instead of Atomic</h2><div class="code-block" data-lang="none"         >
#cat /etc/clickhouse-server/users.d/disable_atomic_database.xml 
linkTitle: &quot;cat /etc/clickhouse-server/users.d/disable_atomic_database.xml &quot;
description: &gt;
    cat /etc/clickhouse-server/users.d/disable_atomic_database.xml
---
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;clickhouse&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;default_database_engine&gt;Ordinary&lt;/default_database_engine&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/clickhouse&gt;
</div></section><section class="chapter"><h2 id="other-sources" data-toc="other-sources"   >Other sources</h2><p id="bb6553dd_917">Presentation <a href="https://youtu.be/1LVJ_WcLgF8?t=2744" id="bb6553dd_918"   data-external="true" rel="noopener noreferrer" >https://youtu.be/1LVJ_WcLgF8?t=2744</a></p><p id="bb6553dd_919"><a href="https://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup46/database_engines.pdf" id="bb6553dd_920"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup46/database_engines.pdf</a></p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-how-to-convert-atomic-to-ordinary.html">How to Convert Atomic to Ordinary</a>   <a class="navigation-links__next" href="how-to-convert-ordinary-to-atomic.html">How to Convert Ordinary to Atomic</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>