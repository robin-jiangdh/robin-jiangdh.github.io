<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:22.8421849"><meta name="build-number" content="${buildNumber}">       <title>MATERIALIZED VIEWS | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"materialized-views-linktitle-materialized-views-description-materialized-views","level":0,"title":"#MATERIALIZED VIEWS\nlinkTitle: \"MATERIALIZED VIEWS\"\ndescription: \u003e\nMATERIALIZED VIEWS","anchor":"#materialized-views-linktitle-materialized-views-description-materialized-views"},{"id":"best-practices","level":0,"title":"Best practices","anchor":"#best-practices"},{"id":"faq","level":0,"title":"FAQ","anchor":"#faq"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="MATERIALIZED VIEWS | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/materialized-views-index.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="MATERIALIZED VIEWS | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/materialized-views-index.html#webpage", "url": "/1.0/materialized-views-index.html", "name": "MATERIALIZED VIEWS | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="materialized-views_index" data-main-title="MATERIALIZED VIEWS" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-schema-design///materialized-views"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="materialized-views_index"   id="materialized-views_index.md">MATERIALIZED VIEWS</h1>  <section class="chapter"><h2 id="materialized-views-linktitle-materialized-views-description-materialized-views" data-toc="materialized-views-linktitle-materialized-views-description-materialized-views"   >#MATERIALIZED VIEWS
linkTitle: &quot;MATERIALIZED VIEWS&quot;
description: &gt;
MATERIALIZED VIEWS</h2><p id="459e381e_689">MATERIALIZED VIEWs in ClickHouse behave like AFTER INSERT TRIGGER to the left-most table listed in its SELECT statement.</p></section><ul class="list _ul" id="459e381e_690"><li class="list__item" id="459e381e_691"><p>Clickhouse and the magic of materialized views. Basics explained with examples: <a href="https://Robinjiang.com/webinarspage/2019/6/26/clickhouse-and-the-magic-of-materialized-views" id="459e381e_692"   data-external="true" rel="noopener noreferrer" >webinar recording</a></p></li><li class="list__item" id="459e381e_693"><p>Everything you should know about materialized views. Very detailed information about internals: <a href="https://youtu.be/ckChUkC3Pns?t=9353" id="459e381e_694"   data-external="true" rel="noopener noreferrer" >video</a>, <a href="https://den-crane.github.io/Everything_you_should_know_about_materialized_views_commented.pdf" id="459e381e_695"   data-external="true" rel="noopener noreferrer" >annotated presentation</a>, <a href="https://github.com/ClickHouse/clickhouse-presentations/blob/master/meetup47/materialized_views.pdf" id="459e381e_696"   data-external="true" rel="noopener noreferrer" >presentation</a></p></li></ul><section class="chapter"><h2 id="best-practices" data-toc="best-practices"   >Best practices</h2><ol class="list _decimal" id="459e381e_697" type="1"><li class="list__item" id="459e381e_698"><p id="459e381e_699">Use MATERIALIZED VIEW with TO syntax (explicit storage table)</p><p id="459e381e_700">First you create the table which will store the data calculated by MV explicitly, and after that create materialized view itself with TO syntax.</p><div class="code-block" data-lang="none"         >
CREATE TABLE target ( ... ) Engine=[Replicated][Replacing/Summing/...]MergeTree ...;

CREATE MATERIALIZED VIEW mv_source2target TO target
AS SELECT ... FROM source;
</div><p id="459e381e_702">That way it's bit simpler to do schema migrations or build more complicated pipelines when one table is filled by several MV.</p><p id="459e381e_703">With engine=Atomic it hard to map undelying table with the MV.</p></li><li class="list__item" id="459e381e_704"><p id="459e381e_705">Avoid using POPULATE when creating MATERIALIZED VIEW on big tables.</p><p id="459e381e_706">Use manual backfilling (with the same query) instead.</p><ul class="list _ul" id="459e381e_707"><li class="list__item" id="459e381e_708"><p>With POPULATE the data ingested to the source table <span class="control" id="459e381e_709">during MV populating will not appear in MV</span>.</p></li><li class="list__item" id="459e381e_710"><p>POPULATE doesn't work with TO syntax.</p></li><li class="list__item" id="459e381e_711"><p>With manual backfilling, you have much better control on the process - you can do it in parts, adjust settings etc.</p></li><li class="list__item" id="459e381e_712"><p>In case of some failure 'in the middle (for example due to timeouts), it's hard to understand the state of the MV.</p></li></ul><div class="code-block" data-lang="none"         >
CREATE MATERIALIZED VIEW mv_source2target TO target
AS SELECT ... FROM source WHERE cond &gt; ...

INSERT INTO target SELECT ... FROM source WHERE cond &lt; ...
</div><p id="459e381e_714">This way you have full control backfilling process (you can backfill in smaller parts to avoid timeouts, do some cross-checks / integrity-checks, change some settings, etc.)</p></li></ol></section><section class="chapter"><h2 id="faq" data-toc="faq"   >FAQ</h2><section class="chapter"><h3 id="q-can-i-attach-materialized-view-to-the-view-or-engine-merge-or-engine-mysql-etc" data-toc="q-can-i-attach-materialized-view-to-the-view-or-engine-merge-or-engine-mysql-etc"   >Q. Can I attach MATERIALIZED VIEW to the VIEW, or engine=Merge, or engine=MySQL, etc.?</h3><p id="459e381e_715">Since MATERIALIZED VIEWs are updated on every INSERT to the underlying table and you can not insert anything to the usual VIEW, the materialized view update will never be triggered.</p><p id="459e381e_716">Normally you should build MATERIALIZED VIEWs on the top of the table with MergeTree engine family.</p></section><section class="chapter"><h3 id="q-i-ve-created-materialized-error-with-some-error-and-since-it-s-it-reading-from-kafka-i-don-t-understand-where-the-error-is" data-toc="q-i-ve-created-materialized-error-with-some-error-and-since-it-s-it-reading-from-kafka-i-don-t-understand-where-the-error-is"   >Q. I've created materialized error with some error, and since it's it reading from Kafka I don't understand where the error is</h3><p id="459e381e_717">Server logs will help you. Also, see the next question.</p></section><section class="chapter"><h3 id="q-how-to-debug-misbehaving-materialized-view" data-toc="q-how-to-debug-misbehaving-materialized-view"   >Q. How to debug misbehaving MATERIALIZED VIEW?</h3><p id="459e381e_718">You can also attach the same MV to some dummy table with engine=Log (or even Null) and do some manual inserts there to debug the behavior. Similar way (as the Materialized view often can contain some pieces of the business logic of the application) you can create tests for your schema.</p><p id="459e381e_719">Always test MATERIALIZED VIEWs first on staging or testing environments</p><p id="459e381e_720">Possible test scenario:</p><ol class="list _decimal" id="459e381e_721" type="1"><li class="list__item" id="459e381e_722"><p>create a copy of the original table <code class="code" id="459e381e_723">CREATE TABLE src_copy ... AS src</code></p></li><li class="list__item" id="459e381e_724"><p>create MV on that copy <code class="code" id="459e381e_725">CREATE MATERIALIZED VIEW ... AS SELECT ... FROM src_copy</code></p></li><li class="list__item" id="459e381e_726"><p>check if inserts to src_copy work properly, and mv is properly filled. <code class="code" id="459e381e_727">INSERT INTO src_copy SELECT * FROM src LIMIT 100</code></p></li><li class="list__item" id="459e381e_728"><p>cleanup the temp stuff and recreate MV on real table.</p></li></ol></section><section class="chapter"><h3 id="q-can-i-use-subqueries-joins-in-mv" data-toc="q-can-i-use-subqueries-joins-in-mv"   >Q. Can I use subqueries / joins in MV?</h3><p id="459e381e_729">It is possible but it is <span class="control" id="459e381e_730">a very bad idea</span> for most of the use cases**.**</p><p id="459e381e_731">So it will most probably work not as you expect and will hit insert performance significantly.</p><p id="459e381e_732">The MV will be attached (as AFTER INSERT TRIGGER) to the left-most table in the MV SELECT statement, and it will 'see' only freshly inserted rows there. It will 'see' the whole set of rows of other tables, and the query will be executed EVERY TIME you do the insert to the left-most table. That will impact the performance speed there significantly. If you really need to update the MV with the left-most table, not impacting the performance so much you can consider using dictionary / engine=Join / engine=Set for right-hand table / subqueries (that way it will be always in memory, ready to use).</p></section><section class="chapter"><h3 id="q-how-to-alter-mv-implicit-storage-w-o-to-syntax" data-toc="q-how-to-alter-mv-implicit-storage-w-o-to-syntax"   >Q. How to alter MV implicit storage (w/o TO syntax)</h3><ol class="list _decimal" id="459e381e_733" type="1"><li class="list__item" id="459e381e_734"><p id="459e381e_735">take the existing MV definition</p><div class="code-block" data-lang="none"         >
SHOW CREATE TABLE dbname.mvname;
</div><p id="459e381e_737">Adjust the query in the following manner:</p><ul class="list _ul" id="459e381e_738"><li class="list__item" id="459e381e_739"><p>replace 'CREATE MATERIALIZED VIEW' to 'ATTACH MATERIALIZED VIEW'</p></li><li class="list__item" id="459e381e_740"><p>add needed columns;</p></li></ul></li><li class="list__item" id="459e381e_741"><p id="459e381e_742">Detach materialized view with the command:</p><div class="code-block" data-lang="none"         >
DETACH TABLE dbname.mvname ON CLUSTER cluster_name;
</div></li><li class="list__item" id="459e381e_744"><p id="459e381e_745">Add the needed column to the underlying ReplicatedAggregatingMergeTree table</p><div class="code-block" data-lang="none"         >
-- if the Materialized view was created without TO keyword
ALTER TABLE dbname.`.inner.mvname` ON CLUSTER cluster_name add column tokens AggregateFunction(uniq, UInt64);
-- othewise just alter the target table used in `CREATE MATERIALIZED VIEW ...`  `TO ...` clause
</div></li><li class="list__item" id="459e381e_747"><p id="459e381e_748">attach MV back using the query you create at p. 1.</p><div class="code-block" data-lang="none"         >
ATTACH MATERIALIZED VIEW dbname.mvname ON CLUSTER cluster_name
(
    /* ... */
    `tokens` AggregateFunction(uniq, UInt64)
)
ENGINE = ReplicatedAggregatingMergeTree(...)
ORDER BY ...
AS
SELECT
    /* ... */
    uniqState(rand64()) as tokens
FROM /* ... */
GROUP BY /* ... */
</div></li></ol><p id="459e381e_750">As you can see that operation is NOT atomic, so the safe way is to stop data ingestion during that procedure.</p><p id="459e381e_751">If you have version 19.16.13 or newer you can change the order of step 2 and 3 making the period when MV is detached and not working shorter (related issue <a href="https://github.com/ClickHouse/ClickHouse/issues/7878" id="459e381e_752"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/issues/7878</a>).</p><p id="459e381e_753">See also:</p><ul class="list _ul" id="459e381e_754"><li class="list__item" id="459e381e_755"><p><a href="https://github.com/ClickHouse/ClickHouse/issues/1226" id="459e381e_756"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/issues/1226</a></p></li><li class="list__item" id="459e381e_757"><p><a href="https://github.com/ClickHouse/ClickHouse/pull/7533" id="459e381e_758"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/pull/7533</a></p></li></ul></section></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="codecs-on-array-columns.html">Codecs on array columns</a>   <a class="navigation-links__next" href="idempotent-inserts-mv.html">Idempotent inserts into a materialized view</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>