<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.5443387"><meta name="build-number" content="${buildNumber}">       <title>Suspiciously many broken parts | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"suspiciously-many-broken-parts-linktitle-suspiciously-many-broken-parts-description-suspiciously-many-broken-parts-error-during-the-server-startup","level":0,"title":"#Suspiciously many broken parts\nlinkTitle: \"Suspiciously many broken parts\"\ndescription: \u003e\nSuspiciously many broken parts error during the server startup.","anchor":"#suspiciously-many-broken-parts-linktitle-suspiciously-many-broken-parts-description-suspiciously-many-broken-parts-error-during-the-server-startup"},{"id":"symptom","level":0,"title":"Symptom:","anchor":"#symptom"},{"id":"cause","level":0,"title":"Cause:","anchor":"#cause"},{"id":"action","level":0,"title":"Action:","anchor":"#action"},{"id":"scenario-illustrating-testing","level":0,"title":"Scenario illustrating / testing","anchor":"#scenario-illustrating-testing"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Suspiciously many broken parts | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/suspiciously-many-broken-parts.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Suspiciously many broken parts | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/suspiciously-many-broken-parts.html#webpage", "url": "/blog/1.0/suspiciously-many-broken-parts.html", "name": "Suspiciously many broken parts | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="suspiciously-many-broken-parts" data-main-title="Suspiciously many broken parts" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="suspiciously-many-broken-parts"   id="suspiciously-many-broken-parts.md">Suspiciously many broken parts</h1>  <section class="chapter"><h2 id="suspiciously-many-broken-parts-linktitle-suspiciously-many-broken-parts-description-suspiciously-many-broken-parts-error-during-the-server-startup" data-toc="suspiciously-many-broken-parts-linktitle-suspiciously-many-broken-parts-description-suspiciously-many-broken-parts-error-during-the-server-startup"   >#Suspiciously many broken parts
linkTitle: &quot;Suspiciously many broken parts&quot;
description: &gt;
Suspiciously many broken parts error during the server startup.</h2></section><section class="chapter"><h2 id="symptom" data-toc="symptom"   >Symptom:</h2><p id="8e1adb61_460">clickhouse don't start with a message <code class="code" id="8e1adb61_461">DB::Exception: Suspiciously many broken parts to remove.</code></p></section><section class="chapter"><h2 id="cause" data-toc="cause"   >Cause:</h2><p id="8e1adb61_462">That exception is just a safeguard check/circuit breaker, triggered when clickhouse detects a lot of broken parts during server startup.</p><p id="8e1adb61_463">Parts are considered broken if they have bad checksums or some files are missing or malformed. Usually, that means the data was corrupted on the disk.</p><p id="8e1adb61_464">Why data could be corrupted?</p><ol class="list _decimal" id="8e1adb61_465" type="1"><li class="list__item" id="8e1adb61_466"><p id="8e1adb61_467">the most often reason is a hard restart of the system, leading to a loss of the data which was not fully flushed to disk from the system page cache. Please be aware that by default ClickHouse doesn't do fsync, so data is considered inserted after it was passed to the Linux page cache. See fsync-related settings in ClickHouse.</p></li><li class="list__item" id="8e1adb61_468"><p id="8e1adb61_469">it can also be caused by disk failures, maybe there are bad blocks on hard disk, or logical problems, or some raid issue. Check system journals, use <code class="code" id="8e1adb61_470">fsck</code>/<code class="code" id="8e1adb61_471">mdadm</code> and other standard tools to diagnose the disk problem.</p></li><li class="list__item" id="8e1adb61_472"><p id="8e1adb61_473">other reasons: manual intervention/bugs etc, for example, the data files or folders are removed by mistake or moved to another folder.</p></li></ol></section><section class="chapter"><h2 id="action" data-toc="action"   >Action:</h2><ol class="list _decimal" id="8e1adb61_474" type="1"><li class="list__item" id="8e1adb61_475"><p id="8e1adb61_476">If you ok to accept the data loss: set up <code class="code" id="8e1adb61_477">force_restore_data</code> flag and clickhouse will move the parts to detached. Data loss is possible if the issue is a result of misconfiguration (i.e. someone accidentally has fixed xml configs with incorrect shard/replica macros, data will be moved to detached folder and can be recovered).</p><div class="code-block" data-lang="none"         >
sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
</div><p id="8e1adb61_479">then restart clickhouse, the table will be attached, and the broken parts will be detached, which means the data from those parts will not be available for the selects. You can see the list of those parts in the <code class="code" id="8e1adb61_480">system.detached_parts</code> table and drop them if needed using <code class="code" id="8e1adb61_481">ALTER TABLE ... DROP DETACHED PART ...</code> commands.</p><p id="8e1adb61_482">If you are ok to tolerate bigger losses automatically you can change that safeguard configuration to be less sensitive by increasing <code class="code" id="8e1adb61_483">max_suspicious_broken_parts</code> setting:</p><div class="code-block" data-lang="none"         >
cat /etc/clickhouse-server/config.d/max_suspicious_broken_parts.xml
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;yandex&gt;
     &lt;merge_tree&gt;
         &lt;max_suspicious_broken_parts&gt;50&lt;/max_suspicious_broken_parts&gt;
     &lt;/merge_tree&gt;
&lt;/yandex&gt;
</div><p id="8e1adb61_485">this limit is set to 10 by default, we can set a bigger value (50 or 100 or more), but the data will lose because of the corruption.</p><p id="8e1adb61_486">Check also a similar setting <code class="code" id="8e1adb61_487">max_suspicious_broken_parts_bytes</code>. <br> See https://clickhouse.com/docs/en/operations/settings/merge-tree-settings/</p></li><li class="list__item" id="8e1adb61_489"><p id="8e1adb61_490">If you can't accept the data loss - you should recover data from backups / re-insert it once again etc.</p><p id="8e1adb61_491">If you don't want to tolerate automatic detaching of broken parts, you can set <code class="code" id="8e1adb61_492">max_suspicious_broken_parts_bytes</code> and <code class="code" id="8e1adb61_493">max_suspicious_broken_parts</code> to 0.</p></li></ol></section><section class="chapter"><h2 id="scenario-illustrating-testing" data-toc="scenario-illustrating-testing"   >Scenario illustrating / testing</h2><ol class="list _decimal" id="8e1adb61_494" type="1"><li class="list__item" id="8e1adb61_495"><p>Create table</p></li></ol><div class="code-block" data-lang="none"         >
create table t111(A UInt32) Engine=MergeTree order by A settings max_suspicious_broken_parts=1;
insert into t111 select number from numbers(100000);
</div><ol class="list _decimal" id="8e1adb61_497" type="1" start="2"><li class="list__item" id="8e1adb61_498"><p>Detach the table and make Data corruption</p></li></ol><div class="code-block" data-lang="none"         >
detach table t111;
</div><p id="8e1adb61_500">cd /var/lib/clickhouse/data/default/t111/all_*** make data file corruption:</p><div class="code-block" data-lang="none"         >
&gt; data.bin
</div><p id="8e1adb61_502">repeat for 2 or more data files.</p><ol class="list _decimal" id="8e1adb61_503" type="1" start="3"><li class="list__item" id="8e1adb61_504"><p>Attach the table:</p></li></ol><div class="code-block" data-lang="none"         >
attach table t111;
 
Received exception from server (version 21.12.3):
Code: 231. DB::Exception: Received from localhost:9000. DB::Exception: Suspiciously many (2) broken parts to remove.. (TOO_MANY_UNEXPEC
</div><ol class="list _decimal" id="8e1adb61_506" type="1" start="4"><li class="list__item" id="8e1adb61_507"><p>setup force_restrore_data flag</p></li></ol><div class="code-block" data-lang="none"         >
sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
sudo service clickhouse-server restart
</div><p id="8e1adb61_509">then the table <code class="code" id="8e1adb61_510">t111</code> will be attached lost the corrupted data.</p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="sysall.html">sysall database (system tables on a cluster level)</a>   <a class="navigation-links__next" href="ssl-connection-unexpectedly-closed.html">SSL connection unexpectedly closed</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>