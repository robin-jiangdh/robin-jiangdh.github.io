<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:22.0943755"><meta name="build-number" content="${buildNumber}">       <title>JVM sizes and garbage collector settings | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"jvm-sizes-and-garbage-collector-settings-linktitle-jvm-sizes-and-garbage-collector-settings-description-jvm-sizes-and-garbage-collector-settings","level":0,"title":"#JVM sizes and garbage collector settings\nlinkTitle: \"JVM sizes and garbage collector settings\"\ndescription: \u003e\nJVM sizes and garbage collector settings","anchor":"#jvm-sizes-and-garbage-collector-settings-linktitle-jvm-sizes-and-garbage-collector-settings-description-jvm-sizes-and-garbage-collector-settings"},{"id":"tldr-version","level":0,"title":"TLDR version","anchor":"#tldr-version"},{"id":"details","level":0,"title":"Details","anchor":"#details"},{"id":"zookeeper-configurarion-used-by-yandex-metrika-from-2017","level":0,"title":"Zookeeper configurarion used by Yandex Metrika (from 2017)","anchor":"#zookeeper-configurarion-used-by-yandex-metrika-from-2017"},{"id":"see-also","level":0,"title":"See also","anchor":"#see-also"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="JVM sizes and garbage collector settings | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/jvm-sizes-and-garbage-collector-settings.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="JVM sizes and garbage collector settings | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/jvm-sizes-and-garbage-collector-settings.html#webpage", "url": "/1.0/jvm-sizes-and-garbage-collector-settings.html", "name": "JVM sizes and garbage collector settings | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="jvm-sizes-and-garbage-collector-settings" data-main-title="JVM sizes and garbage collector settings" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance///kb-zookeeper"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="jvm-sizes-and-garbage-collector-settings"   id="jvm-sizes-and-garbage-collector-settings.md">JVM sizes and garbage collector settings</h1>  <section class="chapter"><h2 id="jvm-sizes-and-garbage-collector-settings-linktitle-jvm-sizes-and-garbage-collector-settings-description-jvm-sizes-and-garbage-collector-settings" data-toc="jvm-sizes-and-garbage-collector-settings-linktitle-jvm-sizes-and-garbage-collector-settings-description-jvm-sizes-and-garbage-collector-settings"   >#JVM sizes and garbage collector settings
linkTitle: &quot;JVM sizes and garbage collector settings&quot;
description: &gt;
JVM sizes and garbage collector settings</h2></section><section class="chapter"><h2 id="tldr-version" data-toc="tldr-version"   >TLDR version</h2><p id="5f8310d1_407">use fresh Java version (11 or newer), disable swap and set up (for 4 Gb node):</p><div class="code-block" data-lang="none"         >
JAVA_OPTS=&quot;-Xms512m -Xmx3G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&quot;
</div><p id="5f8310d1_409">If you have a node with more RAM - change it accordingly, for example for 8Gb node:</p><div class="code-block" data-lang="none"         >
JAVA_OPTS=&quot;-Xms512m -Xmx7G -XX:+AlwaysPreTouch -Djute.maxbuffer=8388608 -XX:MaxGCPauseMillis=50&quot;
</div></section><section class="chapter"><h2 id="details" data-toc="details"   >Details</h2><ol class="list _decimal" id="5f8310d1_411" type="1"><li class="list__item" id="5f8310d1_412"><p id="5f8310d1_413">ZooKeeper runs as in JVM. Depending on version different garbage collectors are available.</p></li><li class="list__item" id="5f8310d1_414"><p id="5f8310d1_415">Recent JVM versions (starting from 10) use <code class="code" id="5f8310d1_416">G1</code> garbage collector by default (should work fine). On JVM 13-14 using <code class="code" id="5f8310d1_417">ZGC</code> or <code class="code" id="5f8310d1_418">Shenandoah</code> garbage collector may reduce pauses. On older JVM version (before 10) you may want to make some tuning to decrease pauses, ParNew + CMS garbage collectors (like in Yandex config) is one of the best options.</p></li><li class="list__item" id="5f8310d1_419"><p id="5f8310d1_420">One of the most important setting for JVM application is heap size. A heap size of &gt;1 GB is recommended for most use cases and monitoring heap usage to ensure no delays are caused by garbage collection. We recommend to use at least 4Gb of RAM for zookeeper nodes (8Gb is better, that will make difference only when zookeeper is heavily loaded).</p></li></ol><p id="5f8310d1_421">Set the Java heap size smaller than available RAM size on the node. This is very important to avoid swapping, which will seriously degrade ZooKeeper performance. Be conservative - use a maximum heap size of 3GB for a 4GB machine.</p><ol class="list _decimal" id="5f8310d1_422" type="1"><li class="list__item" id="5f8310d1_423"><p id="5f8310d1_424">Add <code class="code" id="5f8310d1_425">XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p></li><li class="list__item" id="5f8310d1_426"><p id="5f8310d1_427">Set min (<code class="code" id="5f8310d1_428">Xms</code>) heap size to the values like 512Mb, or even to the same value as max (<code class="code" id="5f8310d1_429">Xmx</code>) to avoid resizing and returning the RAM to OS. Add <code class="code" id="5f8310d1_430">XX:+AlwaysPreTouch</code> flag as well to load the memory pages into memory at the start of the zookeeper.</p></li><li class="list__item" id="5f8310d1_431"><p id="5f8310d1_432"><code class="code" id="5f8310d1_433">MaxGCPauseMillis=50</code> (by default 200) - the 'target' acceptable pause for garbage collection (milliseconds)</p></li><li class="list__item" id="5f8310d1_434"><p id="5f8310d1_435"><code class="code" id="5f8310d1_436">jute.maxbuffer</code> limits the maximum size of znode content. By default it's 1Mb. In some usecases (lot of partitions in table) ClickHouse may need to create bigger znodes.</p></li><li class="list__item" id="5f8310d1_437"><p id="5f8310d1_438">(optional) enable GC logs: <code class="code" id="5f8310d1_439">-Xloggc:/path_to/gc.log</code></p></li></ol></section><section class="chapter"><h2 id="zookeeper-configurarion-used-by-yandex-metrika-from-2017" data-toc="zookeeper-configurarion-used-by-yandex-metrika-from-2017"   >Zookeeper configurarion used by Yandex Metrika (from 2017)</h2><p id="5f8310d1_440">The configuration used by Yandex (<a href="https://clickhouse.tech/docs/en/operations/tips/#zookeeper" id="5f8310d1_441"   data-external="true" rel="noopener noreferrer" >https://clickhouse.tech/docs/en/operations/tips/#zookeeper</a>) - they use older JVM version (with <code class="code" id="5f8310d1_442">UseParNewGC</code> garbage collector), and tune GC logs heavily:</p><div class="code-block" data-lang="none"         >
JAVA_OPTS=&quot;-Xms{{ cluster.get('xms','128M') }} \
    -Xmx{{ cluster.get('xmx','1G') }} \
    -Xloggc:/var/log/$NAME/zookeeper-gc.log \
    -XX:+UseGCLogFileRotation \
    -XX:NumberOfGCLogFiles=16 \
    -XX:GCLogFileSize=16M \
    -verbose:gc \
    -XX:+PrintGCTimeStamps \
    -XX:+PrintGCDateStamps \
    -XX:+PrintGCDetails
    -XX:+PrintTenuringDistribution \
    -XX:+PrintGCApplicationStoppedTime \
    -XX:+PrintGCApplicationConcurrentTime \
    -XX:+PrintSafepointStatistics \
    -XX:+UseParNewGC \
    -XX:+UseConcMarkSweepGC \
    -XX:+CMSParallelRemarkEnabled&quot;
</div></section><section class="chapter"><h2 id="see-also" data-toc="see-also"   >See also</h2><ul class="list _ul" id="5f8310d1_444"><li class="list__item" id="5f8310d1_445"><p><a href="https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs" id="5f8310d1_446"   data-external="true" rel="noopener noreferrer" >https://wikitech.wikimedia.org/wiki/JVM_Tuning#G1_for_full_gcs</a></p></li><li class="list__item" id="5f8310d1_447"><p><a href="https://sematext.com/blog/java-garbage-collection-tuning/" id="5f8310d1_448"   data-external="true" rel="noopener noreferrer" >https://sematext.com/blog/java-garbage-collection-tuning/</a></p></li><li class="list__item" id="5f8310d1_449"><p><a href="https://www.oracle.com/technical-resources/articles/java/g1gc.html" id="5f8310d1_450"   data-external="true" rel="noopener noreferrer" >https://www.oracle.com/technical-resources/articles/java/g1gc.html</a></p></li><li class="list__item" id="5f8310d1_451"><p><a href="https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2" id="5f8310d1_452"   data-external="true" rel="noopener noreferrer" >https://docs.oracle.com/cd/E40972_01/doc.70/e40973/cnf_jvmgc.htm#autoId2</a></p></li><li class="list__item" id="5f8310d1_453"><p><a href="https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html" id="5f8310d1_454"   data-external="true" rel="noopener noreferrer" >https://docs.cloudera.com/runtime/7.2.7/kafka-performance-tuning/topics/kafka-tune-broker-tuning-jvm.html</a></p></li><li class="list__item" id="5f8310d1_455"><p><a href="https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html" id="5f8310d1_456"   data-external="true" rel="noopener noreferrer" >https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cm-tune-g1gc.html</a></p></li><li class="list__item" id="5f8310d1_457"><p><a href="https://blog.sokolenko.me/2014/11/javavm-options-production.html" id="5f8310d1_458"   data-external="true" rel="noopener noreferrer" >https://blog.sokolenko.me/2014/11/javavm-options-production.html</a></p></li><li class="list__item" id="5f8310d1_459"><p><a href="https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers" id="5f8310d1_460"   data-external="true" rel="noopener noreferrer" >https://www.maknesium.de/21-most-important-java-8-vm-options-for-servers</a></p></li><li class="list__item" id="5f8310d1_461"><p><a href="https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304" id="5f8310d1_462"   data-external="true" rel="noopener noreferrer" >https://docs.oracle.com/javase/10/gctuning/introduction-garbage-collection-tuning.htm#JSGCT-GUID-326EB4CF-8C8C-4267-8355-21AB04F0D304</a></p></li><li class="list__item" id="5f8310d1_463"><p><a href="https://github.com/chewiebug/GCViewer" id="5f8310d1_464"   data-external="true" rel="noopener noreferrer" >https://github.com/chewiebug/GCViewer</a></p></li></ul></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-how-to-check-the-list-of-watches.html">How to check the list of watches</a>   <a class="navigation-links__next" href="install-ubuntu.html">Install standalone Zookeeper for ClickHouse on Ubuntu / Debian</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>