<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.2337553"><meta name="build-number" content="${buildNumber}">       <title>KILL QUERY | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"kill-query-linktitle-kill-query-description-kill-query","level":0,"title":"#KILL QUERY\nlinkTitle: \"KILL QUERY\"\ndescription: \u003e\nKILL QUERY","anchor":"#kill-query-linktitle-kill-query-description-kill-query"},{"id":"how-to-replace-a-running-query","level":0,"title":"How to replace a running query","anchor":"#how-to-replace-a-running-query"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="KILL QUERY | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/kb-kill-query.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="KILL QUERY | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/kb-kill-query.html#webpage", "url": "/blog/1.0/kb-kill-query.html", "name": "KILL QUERY | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-kill-query" data-main-title="KILL QUERY" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-queries-and-syntax"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-kill-query"   id="kb-kill-query.md">KILL QUERY</h1>  <section class="chapter"><h2 id="kill-query-linktitle-kill-query-description-kill-query" data-toc="kill-query-linktitle-kill-query-description-kill-query"   >#KILL QUERY
linkTitle: &quot;KILL QUERY&quot;
description: &gt;
KILL QUERY</h2><p id="c7f7dccf_190">Unfortunately not all queries can be killed. <code class="code" id="c7f7dccf_191">KILL QUERY</code> only sets a flag that must be checked by the query. A query pipeline is checking this flag before a switching to next block. If the pipeline has stuck somewhere in the middle it cannot be killed. If a query does not stop, the only way to get rid of it is to restart ClickHouse.</p><p id="c7f7dccf_192">See also</p><p id="c7f7dccf_193"><a href="https://github.com/ClickHouse/ClickHouse/issues/3964" id="c7f7dccf_194"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/issues/3964</a> <a href="https://github.com/ClickHouse/ClickHouse/issues/1576" id="c7f7dccf_195"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/issues/1576</a></p></section><section class="chapter"><h2 id="how-to-replace-a-running-query" data-toc="how-to-replace-a-running-query"   >How to replace a running query</h2><aside class="prompt" data-type="tip" data-title="" id="c7f7dccf_196"><p id="c7f7dccf_197">Q. We are trying to abort running queries when they are being replaced with a new one. We are setting the same query id for this. In some cases this error happens:</p><p id="c7f7dccf_198">Query with id = e213cc8c-3077-4a6c-bc78-e8463adad35d is already running and can't be stopped</p><p id="c7f7dccf_199">The query is still being killed but the new one is not being executed. Do you know anything about this and if there is a fix or workaround for it?</p></aside><p id="c7f7dccf_200">I guess you use replace_running_query + replace_running_query_max_wait_ms.</p><p id="c7f7dccf_201">Unfortunately it's not always possible to kill the query at random moment of time.</p><p id="c7f7dccf_202">Kill don't send any signals, it just set a flag. Which gets (synchronously) checked at certain moments of query execution, mostly after finishing processing one block and starting another.</p><p id="c7f7dccf_203">On certain stages (executing scalar sub-query) the query can not be killed at all. This is a known issue and requires an architectural change to fix it.</p><aside class="prompt" data-type="tip" data-title="" id="c7f7dccf_204"><p id="c7f7dccf_205">I see. Is there a workaround?</p><p id="c7f7dccf_206">This is our use case:</p><p id="c7f7dccf_207">A user requests an analytics report which has a query that takes several settings, the user makes changes to the report (e.g. to filters, metrics, dimensions...). Since the user changed what he is looking for the query results from the initial query are never used and we would like to cancel it when starting the new query (edited)</p></aside><p id="c7f7dccf_208">You can just use 2 commands:</p><div class="code-block" data-lang="none"         >
KILL QUERY WHERE query_id = ' ... ' ASYNC

SELECT ... new query ....
</div><p id="c7f7dccf_210">in that case you don't need to care when the original query will be stopped.</p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-optimize-vs-optimize-final.html">OPTIMIZE vs OPTIMIZE FINAL</a>   <a class="navigation-links__next" href="kb-final-clause-speed.html">FINAL clause speed</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>