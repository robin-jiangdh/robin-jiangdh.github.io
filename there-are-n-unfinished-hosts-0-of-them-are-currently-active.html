<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:46.3377091"><meta name="build-number" content="${buildNumber}">       <title>There are N unfinished hosts (0 of them are currently active). | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"there-are-n-unfinished-hosts-0-of-them-are-currently-active-linktitle-there-are-n-unfinished-hosts-0-of-them-are-currently-active-description-there-are-n-unfinished-hosts-0-of-them-are-currently-active","level":0,"title":"#There are N unfinished hosts (0 of them are currently active).\nlinkTitle: \"There are N unfinished hosts (0 of them are currently active).\"\ndescription: \u003e\n\"There are N unfinished hosts (0 of them are currently active).\"","anchor":"#there-are-n-unfinished-hosts-0-of-them-are-currently-active-linktitle-there-are-n-unfinished-hosts-0-of-them-are-currently-active-description-there-are-n-unfinished-hosts-0-of-them-are-currently-active"},{"id":"possible-reasons","level":0,"title":"Possible reasons","anchor":"#possible-reasons"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="There are N unfinished hosts (0 of them are currently active). | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/there-are-n-unfinished-hosts-0-of-them-are-currently-active.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="There are N unfinished hosts (0 of them are currently active). | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/there-are-n-unfinished-hosts-0-of-them-are-currently-active.html#webpage", "url": "/blog/1.0/there-are-n-unfinished-hosts-0-of-them-are-currently-active.html", "name": "There are N unfinished hosts (0 of them are currently active). | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="there-are-n-unfinished-hosts-0-of-them-are-currently-active" data-main-title="There are N unfinished hosts (0 of them are currently active)." data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance///kb-ddlworker"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="there-are-n-unfinished-hosts-0-of-them-are-currently-active"   id="there-are-n-unfinished-hosts-0-of-them-are-currently-active.md">There are N unfinished hosts (0 of them are currently active).</h1>  <section class="chapter"><h2 id="there-are-n-unfinished-hosts-0-of-them-are-currently-active-linktitle-there-are-n-unfinished-hosts-0-of-them-are-currently-active-description-there-are-n-unfinished-hosts-0-of-them-are-currently-active" data-toc="there-are-n-unfinished-hosts-0-of-them-are-currently-active-linktitle-there-are-n-unfinished-hosts-0-of-them-are-currently-active-description-there-are-n-unfinished-hosts-0-of-them-are-currently-active"   >#There are N unfinished hosts (0 of them are currently active).
linkTitle: &quot;There are N unfinished hosts (0 of them are currently active).&quot;
description: &gt;
&quot;There are N unfinished hosts (0 of them are currently active).&quot;</h2><p id="e06a272e_280">Sometimes your Distributed DDL queries are being stuck, and not executing on all or subset of nodes, there are a lot of possible reasons for that kind of behavior, so it would take some time and effort to investigate.</p></section><section class="chapter"><h2 id="possible-reasons" data-toc="possible-reasons"   >Possible reasons</h2><section class="chapter"><h3 id="clickhouse-node-can-t-recognize-itself" data-toc="clickhouse-node-can-t-recognize-itself"   >Clickhouse node can't recognize itself</h3><div class="code-block" data-lang="none"         >
SELECT * FROM system.clusters; -- check is_local column, it should have 1 for itself
</div><div class="code-block" data-lang="none"         >
getent hosts clickhouse.local.net # or other name which should be local
hostname --fqdn

cat /etc/hosts
cat /etc/hostname
</div></section><section class="chapter"><h3 id="debian-ubuntu" data-toc="debian-ubuntu"   >Debian / Ubuntu</h3><p id="e06a272e_283">There is an issue in Debian based images, when hostname being mapped to 127.0.1.1 address which doesn't literally match network interface and clickhouse fails to detect this address as local.</p><p id="e06a272e_284"><a href="https://github.com/ClickHouse/ClickHouse/issues/23504" id="e06a272e_285"   data-external="true" rel="noopener noreferrer" >https://github.com/ClickHouse/ClickHouse/issues/23504</a></p><section class="chapter"><h4 id="previous-task-is-being-executed-and-taking-some-time" data-toc="previous-task-is-being-executed-and-taking-some-time"   >Previous task is being executed and taking some time</h4><p id="e06a272e_286">It's usually some heavy operations like merges, mutations, alter columns, so it make sense to check those tables:</p><div class="code-block" data-lang="none"         >
SHOW PROCESSLIST;
SELECT * FROM system.merges;
SELECT * FROM system.mutations;
</div><p id="e06a272e_288">In that case, you can just wait completion of previous task.</p></section></section><section class="chapter"><h3 id="previous-task-is-stuck-because-of-some-error" data-toc="previous-task-is-stuck-because-of-some-error"   >Previous task is stuck because of some error</h3><p id="e06a272e_289">In that case, the first step is to understand which exact task is stuck and why. There are some queries which can help with that.</p><div class="code-block" data-lang="none"         >
-- list of all distributed ddl queries, path can be different in your installation
SELECT * FROM system.zookeeper WHERE path = '/clickhouse/task_queue/ddl/';

-- information about specific task.
SELECT * FROM system.zookeeper WHERE path = '/clickhouse/task_queue/ddl/query-0000001000/';
SELECT * FROM system.zookeeper WHERE path = '/clickhouse/task_queue/ddl/' AND name = 'query-0000001000';
-- 22.3
SELECT * FROM system.zookeeper WHERE path like '/clickhouse/task_queue/ddl/query-0000001000/%' 
ORDER BY ctime, path SETTINGS allow_unrestricted_reads_from_keeper='true'
-- 22.6
SELECT path, name, value, ctime, mtime 
FROM system.zookeeper WHERE path like '/clickhouse/task_queue/ddl/query-0000001000/%' 
ORDER BY ctime, path SETTINGS allow_unrestricted_reads_from_keeper='true'

-- How many nodes executed this task
SELECT name, numChildren as finished_nodes FROM system.zookeeper
WHERE path = '/clickhouse/task_queue/ddl/query-0000001000/' AND name = 'finished';

┌─name─────┬─finished_nodes─┐
│ finished │              0 │
└──────────┴────────────────┘

-- The nodes that are running the task
SELECT name, value, ctime, mtime FROM system.zookeeper 
WHERE path = '/clickhouse/task_queue/ddl/query-0000001000/active/';

-- What was the result for the finished nodes 
SELECT name, value, ctime, mtime FROM system.zookeeper 
WHERE path = '/clickhouse/task_queue/ddl/query-0000001000/finished/';

-- Latest successfull executed tasks from query_log.
SELECT query FROM system.query_log WHERE query LIKE '%ddl_entry%' AND type = 2 ORDER BY event_time DESC LIMIT 5;

SELECT
    FQDN(),
    *
FROM clusterAllReplicas('cluster', system.metrics)
WHERE metric LIKE '%MaxDDLEntryID%'

┌─FQDN()───────────────────┬─metric────────┬─value─┬─description───────────────────────────┐
│ chi-ab.svc.cluster.local │ MaxDDLEntryID │  1468 │ Max processed DDL entry of DDLWorker. │
└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘
┌─FQDN()───────────────────┬─metric────────┬─value─┬─description───────────────────────────┐
│ chi-ab.svc.cluster.local │ MaxDDLEntryID │  1468 │ Max processed DDL entry of DDLWorker. │
└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘
┌─FQDN()───────────────────┬─metric────────┬─value─┬─description───────────────────────────┐
│ chi-ab.svc.cluster.local │ MaxDDLEntryID │  1468 │ Max processed DDL entry of DDLWorker. │
└──────────────────────────┴───────────────┴───────┴───────────────────────────────────────┘


-- Information about task execution from logs.
grep -C 40 &quot;ddl_entry&quot; /var/log/clickhouse-server/clickhouse-server*.log
</div></section><section class="chapter"><h3 id="issues-that-can-prevent-task-execution" data-toc="issues-that-can-prevent-task-execution"   >Issues that can prevent task execution</h3><section class="chapter"><h4 id="obsolete-replicas" data-toc="obsolete-replicas"   >Obsolete Replicas</h4><p id="e06a272e_291">Obsolete replicas left in zookeeper.</p><div class="code-block" data-lang="none"         >
SELECT database, table, zookeeper_path, replica_path zookeeper FROM system.replicas WHERE total_replicas != active_replicas;

SELECT * FROM system.zookeeper WHERE path = '/clickhouse/cluster/tables/01/database/table/replicas';

SYSTEM DROP REPLICA 'replica_name';

SYSTEM STOP REPLICATION QUEUES;
SYSTEM START REPLICATION QUEUES;
</div><p id="e06a272e_293"><a href="https://clickhouse.tech/docs/en/sql-reference/statements/system/#query_language-system-drop-replica" id="e06a272e_294"   data-external="true" rel="noopener noreferrer" >https://clickhouse.tech/docs/en/sql-reference/statements/system/#query_language-system-drop-replica</a></p></section><section class="chapter"><h4 id="tasks-manually-removed-from-ddl-queue" data-toc="tasks-manually-removed-from-ddl-queue"   >Tasks manually removed from DDL queue</h4><p id="e06a272e_295">Task were removed from DDL queue, but left in Replicated*MergeTree table queue.</p><div class="code-block" data-lang="none"         >
grep -C 40 &quot;ddl_entry&quot; /var/log/clickhouse-server/clickhouse-server*.log

/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:28.956888 [ 599 ] {} &lt;Debug&gt; DDLWorker: Processing task query-0000211211 (ALTER TABLE db.table_local ON CLUSTER `all-replicated` DELETE WHERE id = 1)
/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053555 [ 599 ] {} &lt;Error&gt; DDLWorker: ZooKeeper error: Code: 999, e.displayText() = Coordination::Exception: No node, Stack trace (when copying this message, always include the lines below):
/var/log/clickhouse-server/clickhouse-server.log-
/var/log/clickhouse-server/clickhouse-server.log-0. Coordination::Exception::Exception(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, Coordination::Error, int) @ 0xfb2f6b3 in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log-1. Coordination::Exception::Exception(Coordination::Error) @ 0xfb2fb56 in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log:2. DB::DDLWorker::createStatusDirs(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::shared_ptr&lt;zkutil::ZooKeeper&gt; const&amp;) @ 0xeb3127a in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log:3. DB::DDLWorker::processTask(DB::DDLTask&amp;) @ 0xeb36c96 in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log:4. DB::DDLWorker::enqueueTask(std::__1::unique_ptr&lt;DB::DDLTask, std::__1::default_delete&lt;DB::DDLTask&gt; &gt;) @ 0xeb35f22 in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log-5. ? @ 0xeb47aed in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log-6. ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::worker(std::__1::__list_iterator&lt;ThreadFromGlobalPool, void*&gt;) @ 0x8633bcd in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log-7. ThreadFromGlobalPool::ThreadFromGlobalPool&lt;void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;(std::__1::function&lt;void ()&gt;, int, std::__1::optional&lt;unsigned long&gt;)::'lambda1'()&gt;(void&amp;&amp;, void ThreadPoolImpl&lt;ThreadFromGlobalPool&gt;::scheduleImpl&lt;void&gt;(std::__1::function&lt;void ()&gt;, int, std::__1::optional&lt;unsigned long&gt;)::'lambda1'()&amp;&amp;...)::'lambda'()::operator()() @ 0x863612f in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log-8. ThreadPoolImpl&lt;std::__1::thread&gt;::worker(std::__1::__list_iterator&lt;std::__1::thread, void*&gt;) @ 0x8630ffd in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log-9. ? @ 0x8634bb3 in /usr/bin/clickhouse
/var/log/clickhouse-server/clickhouse-server.log-10. start_thread @ 0x9609 in /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
/var/log/clickhouse-server/clickhouse-server.log-11. __clone @ 0x122293 in /usr/lib/x86_64-linux-gnu/libc-2.31.so
/var/log/clickhouse-server/clickhouse-server.log- (version 21.1.8.30 (official build))
/var/log/clickhouse-server/clickhouse-server.log:2021.05.04 12:41:29.053951 [ 599 ] {} &lt;Debug&gt; DDLWorker: Processing task query-0000211211 (ALTER TABLE db.table_local ON CLUSTER `all-replicated` DELETE WHERE id = 1)
</div><p id="e06a272e_297">Context of this problem is:</p><ul class="list _ul" id="e06a272e_298"><li class="list__item" id="e06a272e_299"><p>Constant pressure of cheap ON CLUSTER DELETE queries.</p></li><li class="list__item" id="e06a272e_300"><p>One replica was down for a long amount of time (multiple days).</p></li><li class="list__item" id="e06a272e_301"><p>Because of pressure on the DDL queue, it purged old records due to the <code class="code" id="e06a272e_302">task_max_lifetime</code> setting.</p></li><li class="list__item" id="e06a272e_303"><p>When a lagging replica comes up, it's fail's execute old queries from DDL queue, because at this point they were purged from it.</p></li></ul><p id="e06a272e_304">Solution:</p><ul class="list _ul" id="e06a272e_305"><li class="list__item" id="e06a272e_306"><p>Reload/Restore this replica from scratch.</p></li></ul></section><section class="chapter"><h4 id="ddl-path-was-changed-in-zookeeper-without-restarting-clickhouse" data-toc="ddl-path-was-changed-in-zookeeper-without-restarting-clickhouse"   >DDL path was changed in Zookeeper without restarting ClickHouse</h4><p id="e06a272e_307">Changing the DDL queue path in Zookeeper without restarting ClickHouse will make ClickHouse confused. If you need to do this ensure that you restart ClickHouse before submitting additional distributed DDL commands. Here's an example.</p><div class="code-block" data-lang="none"         >
-- Path before change:
SELECT *
FROM system.zookeeper
WHERE path = '/clickhouse/clickhouse101/task_queue'

┌─name─┬─value─┬─path─────────────────────────────────┐
│ ddl  │       │ /clickhouse/clickhouse101/task_queue │
└──────┴───────┴──────────────────────────────────────┘

-- Path after change
SELECT *
FROM system.zookeeper
WHERE path = '/clickhouse/clickhouse101/task_queue'

┌─name─┬─value─┬─path─────────────────────────────────┐
│ ddl2 │       │ /clickhouse/clickhouse101/task_queue │
└──────┴───────┴──────────────────────────────────────┘
</div><p id="e06a272e_309">The reason is that ClickHouse will not &quot;see&quot; this change and will continue to look for tasks in the old path. Altering paths in Zookeeper should be avoided if at all possible. If necessary it must be done <span class="emphasis" id="e06a272e_310">very carefuly</span>.</p></section></section></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="20-3-and-earlier.html">clickhouse-copier 20.3 and earlier</a>   <a class="navigation-links__next" href="kb-ddlworker-index.html">DDLWorker</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>