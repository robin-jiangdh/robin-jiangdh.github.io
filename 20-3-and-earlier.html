<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:23.5176538"><meta name="build-number" content="${buildNumber}">       <title>clickhouse-copier 20.3 and earlier | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"clickhouse-copier-20-3-and-earlier-linktitle-clickhouse-copier-20-3-and-earlier-description-clickhouse-copier-20-3-and-earlier","level":0,"title":"#clickhouse-copier 20.3 and earlier\nlinkTitle: \"clickhouse-copier 20.3 and earlier\"\ndescription: \u003e\nclickhouse-copier 20.3 and earlier","anchor":"#clickhouse-copier-20-3-and-earlier-linktitle-clickhouse-copier-20-3-and-earlier-description-clickhouse-copier-20-3-and-earlier"},{"id":"the-process-is-as-follows","level":0,"title":"The process is as follows","anchor":"#the-process-is-as-follows"},{"id":"configuring-the-engine-of-the-target-table","level":0,"title":"Configuring the engine of the target table","anchor":"#configuring-the-engine-of-the-target-table"},{"id":"how-to-monitor-the-status-of-running-tasks","level":0,"title":"How to monitor the status of running tasks","anchor":"#how-to-monitor-the-status-of-running-tasks"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="clickhouse-copier 20.3 and earlier | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/20-3-and-earlier.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="clickhouse-copier 20.3 and earlier | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/20-3-and-earlier.html#webpage", "url": "/1.0/20-3-and-earlier.html", "name": "clickhouse-copier 20.3 and earlier | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="20.3-and-earlier" data-main-title="clickhouse-copier 20.3 and earlier" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance///kb-data-migration///kb-clickhouse-copier"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="20.3-and-earlier"   id="20.3-and-earlier.md">clickhouse-copier 20.3 and earlier</h1>  <section class="chapter"><h2 id="clickhouse-copier-20-3-and-earlier-linktitle-clickhouse-copier-20-3-and-earlier-description-clickhouse-copier-20-3-and-earlier" data-toc="clickhouse-copier-20-3-and-earlier-linktitle-clickhouse-copier-20-3-and-earlier-description-clickhouse-copier-20-3-and-earlier"   >#clickhouse-copier 20.3 and earlier
linkTitle: &quot;clickhouse-copier 20.3 and earlier&quot;
description: &gt;
clickhouse-copier 20.3 and earlier</h2><p id="9755c6a4_155">Clickhouse-copier was created to move data between clusters. It runs simple INSERT&hellip;SELECT queries and can copy data between tables with different engine parameters and between clusters with different number of shards. In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions. Clickhouse-copier uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p></section><section class="chapter"><h2 id="the-process-is-as-follows" data-toc="the-process-is-as-follows"   >The process is as follows</h2><ol class="list _decimal" id="9755c6a4_156" type="1"><li class="list__item" id="9755c6a4_157"><p>Process the configuration files.</p></li><li class="list__item" id="9755c6a4_158"><p>Discover the list of partitions if not provided in the config.</p></li><li class="list__item" id="9755c6a4_159"><p>Copy partitions one by one. </p><ol class="list _decimal" id="9755c6a4_160" type="1"><li class="list__item" id="9755c6a4_161"><p>Drop the partition from the target table if it&rsquo;s not empty</p></li><li class="list__item" id="9755c6a4_162"><p>Copy data from source shards one by one. </p><ol class="list _decimal" id="9755c6a4_163" type="1"><li class="list__item" id="9755c6a4_164"><p>Check if there is data for the partition on a source shard.</p></li><li class="list__item" id="9755c6a4_165"><p>Check the status of the task in ZooKeeper.</p></li><li class="list__item" id="9755c6a4_166"><p>Create target tables on all shards of the target cluster.</p></li><li class="list__item" id="9755c6a4_167"><p>Insert the partition of data into the target table.</p></li></ol></li><li class="list__item" id="9755c6a4_168"><p>Mark the partition as completed in ZooKeeper.</p></li></ol></li></ol><p id="9755c6a4_169">If there are several workers running simultaneously, they will assign themselves to different source shards. If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p></section><section class="chapter"><h2 id="configuring-the-engine-of-the-target-table" data-toc="configuring-the-engine-of-the-target-table"   >Configuring the engine of the target table</h2><p id="9755c6a4_170">Clickhouse-copier uses the engine from the task configuration file for these purposes:</p><ul class="list _ul" id="9755c6a4_171"><li class="list__item" id="9755c6a4_172"><p>to create target tables if they don&rsquo;t exist.</p></li><li class="list__item" id="9755c6a4_173"><p>PARTITION BY: to SELECT a partition of data from the source table, to DROP existing partitions from target tables.</p></li></ul><p id="9755c6a4_174">Clickhouse-copier does not support the old MergeTree format. However, you can create the target tables manually and specify the engine in the task configuration file in the new format so that clickhouse-copier can parse it for its SELECT queries.</p></section><section class="chapter"><h2 id="how-to-monitor-the-status-of-running-tasks" data-toc="how-to-monitor-the-status-of-running-tasks"   >How to monitor the status of running tasks</h2><p id="9755c6a4_175">Clickhouse-copier uses ZooKeeper to keep track of the progress and to communicate between workers. Here is a list of queries that you can use to see what&rsquo;s happening.</p><div class="code-block" data-lang="none"         >
--task-path /clickhouse/copier/task1

-- The task config
select * from system.zookeeper
where path='&lt;task-path&gt;'
name                        | ctime               | mtime           
----------------------------+---------------------+--------------------
description                 | 2019-10-18 15:40:00 | 2020-09-11 16:01:14
task_active_workers_version | 2019-10-18 16:00:09 | 2020-09-11 16:07:08
tables                      | 2019-10-18 16:00:25 | 2019-10-18 16:00:25
task_active_workers         | 2019-10-18 16:00:09 | 2019-10-18 16:00:09


-- Running workers
select * from system.zookeeper
where path='&lt;task-path&gt;/task_active_workers'


-- The list of processed tables
select * from system.zookeeper
where path='&lt;task-path&gt;/tables'


-- The list of processed partitions
select * from system.zookeeper
where path='&lt;task-path&gt;/tables/&lt;table&gt;'
name   | ctime           
-------+--------------------
201909 | 2019-10-18 18:24:18


-- The status of a partition
select * from system.zookeeper
where path='&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;'
name                     | ctime           
-------------------------+--------------------
shards                   | 2019-10-18 18:24:18
partition_active_workers | 2019-10-18 18:24:18


-- The status of source shards
select * from system.zookeeper
where path='&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/shards'
name | ctime               | mtime           
-----+---------------------+--------------------
1    | 2019-10-18 22:37:48 | 2019-10-18 22:49:29
</div></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="20-4-21-6.html">clickhouse-copier 20.4 - 21.6</a>   <a class="navigation-links__next" href="there-are-n-unfinished-hosts-0-of-them-are-currently-active.html">There are N unfinished hosts (0 of them are currently active).</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>