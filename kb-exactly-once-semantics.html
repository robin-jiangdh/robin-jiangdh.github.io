<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.9196465"><meta name="build-number" content="${buildNumber}">       <title>Exactly once semantics | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"exactly-once-semantics-linktitle-exactly-once-semantics-description-exactly-once-semantics","level":0,"title":"#Exactly once semantics\nlinkTitle: \"Exactly once semantics\"\ndescription: \u003e\nExactly once semantics","anchor":"#exactly-once-semantics-linktitle-exactly-once-semantics-description-exactly-once-semantics"},{"id":"block-aggregator-by-ebay","level":0,"title":"block-aggregator by eBay","anchor":"#block-aggregator-by-ebay"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Exactly once semantics | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/kb-exactly-once-semantics.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Exactly once semantics | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/kb-exactly-once-semantics.html#webpage", "url": "/blog/1.0/kb-exactly-once-semantics.html", "name": "Exactly once semantics | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-exactly-once-semantics" data-main-title="Exactly once semantics" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-integrations///kb-kafka"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-exactly-once-semantics"   id="kb-exactly-once-semantics.md">Exactly once semantics</h1>  <section class="chapter"><h2 id="exactly-once-semantics-linktitle-exactly-once-semantics-description-exactly-once-semantics" data-toc="exactly-once-semantics-linktitle-exactly-once-semantics-description-exactly-once-semantics"   >#Exactly once semantics
linkTitle: &quot;Exactly once semantics&quot;
description: &gt;
Exactly once semantics</h2><p id="74bae687_109">EOS consumer (isolation.level=read_committed) is enabled by default since librdkafka 1.2.0, so for ClickHouse - since 20.2</p><p id="74bae687_110">See:</p><ul class="list _ul" id="74bae687_111"><li class="list__item" id="74bae687_112"><p><a href="https://github.com/edenhill/librdkafka/commit/6b2a1552ac2a4ea09d915015183f268dd2df96e6" id="74bae687_113"   data-external="true" rel="noopener noreferrer" >edenhill/librdkafka@6b2a155</a></p></li><li class="list__item" id="74bae687_114"><p><a href="https://github.com/ClickHouse/ClickHouse/commit/9de5dffb5c97eb93545ae25eaf87ec195a590148" id="74bae687_115"   data-external="true" rel="noopener noreferrer" >9de5dff</a></p></li></ul><p id="74bae687_116">BUT: while EOS semantics will guarantee you that no duplicates will happen on the Kafka side (i.e. even if you produce the same messages few times it will be consumed once), but ClickHouse as a Kafka client can currently guarantee only at-least-once. And in some corner cases (connection lost etc) you can get duplicates.</p><p id="74bae687_117">We need to have something like transactions on ClickHouse side to be able to avoid that. Adding something like simple transactions is in plans for Y2022.</p></section><section class="chapter"><h2 id="block-aggregator-by-ebay" data-toc="block-aggregator-by-ebay"   >block-aggregator by eBay</h2><p id="74bae687_118">Block Aggregator is a data loader that subscribes to Kafka topics, aggregates the Kafka messages into blocks that follow the Clickhouse&rsquo;s table schemas, and then inserts the blocks into ClickHouse. Block Aggregator provides exactly-once delivery guarantee to load data from Kafka to ClickHouse. Block Aggregator utilizes Kafka&rsquo;s metadata to keep track of blocks that are intended to send to ClickHouse, and later uses this metadata information to deterministically re-produce ClickHouse blocks for re-tries in case of failures. The identical blocks are guaranteed to be deduplicated by ClickHouse.</p><p id="74bae687_119"><a href="https://github.com/eBay/block-aggregator" id="74bae687_120"   data-external="true" rel="noopener noreferrer" >eBay/block-aggregator</a></p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-kafka-main-parsing-loop.html">Kafka main parsing loop</a>   <a class="navigation-links__next" href="kb-adjusting-librdkafka-settings.html">Adjusting librdkafka settings</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>