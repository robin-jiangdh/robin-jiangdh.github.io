<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.093951"><meta name="build-number" content="${buildNumber}">       <title>ClickHouse and different filesystems | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"clickhouse-and-different-filesystems-linktitle-clickhouse-and-different-filesystems-weight-100-description-clickhouse-and-different-filesystems","level":0,"title":"#ClickHouse and different filesystems\nlinkTitle: \"ClickHouse and different filesystems\"\nweight: 100\ndescription: \u003e-\nClickHouse and different filesystems.","anchor":"#clickhouse-and-different-filesystems-linktitle-clickhouse-and-different-filesystems-weight-100-description-clickhouse-and-different-filesystems"},{"id":"clickhouse-and-different-filesystems","level":0,"title":"ClickHouse and different filesystems","anchor":"#clickhouse-and-different-filesystems"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="ClickHouse and different filesystems | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/filesystems.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="ClickHouse and different filesystems | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/filesystems.html#webpage", "url": "/blog/1.0/filesystems.html", "name": "ClickHouse and different filesystems | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="filesystems" data-main-title="ClickHouse and different filesystems" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="filesystems"   id="filesystems.md">ClickHouse and different filesystems</h1>  <section class="chapter"><h2 id="clickhouse-and-different-filesystems-linktitle-clickhouse-and-different-filesystems-weight-100-description-clickhouse-and-different-filesystems" data-toc="clickhouse-and-different-filesystems-linktitle-clickhouse-and-different-filesystems-weight-100-description-clickhouse-and-different-filesystems"   >#ClickHouse and different filesystems
linkTitle: &quot;ClickHouse and different filesystems&quot;
weight: 100
description: &gt;-
ClickHouse and different filesystems.</h2></section><section class="chapter"><h2 id="clickhouse-and-different-filesystems" data-toc="clickhouse-and-different-filesystems"   >ClickHouse and different filesystems</h2><p id="b4e74441_451">In general ClickHouse should work with any POSIX-compatible filesystem.</p><ul class="list _ul" id="b4e74441_452"><li class="list__item" id="b4e74441_453"><p>hard links and soft links support is mandatory.</p></li><li class="list__item" id="b4e74441_454"><p>clickhouse can use O_DIRECT mode to bypass the cache (and async io)</p></li><li class="list__item" id="b4e74441_455"><p>clickhouse can use renameat2 command for some atomic operations (not all the filesystems support that).</p></li><li class="list__item" id="b4e74441_456"><p>depending on the schema and details of the usage the filesystem load can vary between the setup. The most natural load - is high throughput, with low or moderate IOPS.</p></li><li class="list__item" id="b4e74441_457"><p>data is compressed in clickhouse (LZ4 by default), while indexes / marks / metadata files - no. Enabling disk-level compression can sometimes improve the compression, but can affect read / write speed.</p></li></ul><section class="chapter"><h3 id="ext4" data-toc="ext4"   >ext4</h3><p id="b4e74441_458">no issues, fully supported.</p><p id="b4e74441_459">The minimum kernel version required is 3.15 (newer are recommended)</p></section><section class="chapter"><h3 id="xfs" data-toc="xfs"   >XFS</h3><p id="b4e74441_460">Performance issues reported by users, use on own risk. Old kernels are not recommended (4.0 or newer is recommended).</p><p id="b4e74441_461">According to the users' feedback, XFS behaves worse with ClickHouse under heavy load. We don't have real proofs/benchmarks though, example reports:</p><ul class="list _ul" id="b4e74441_462"><li class="list__item" id="b4e74441_463"><p>In GitHub there are <a href="https://github.com/ClickHouse/ClickHouse/issues/520" id="b4e74441_464"   data-external="true" rel="noopener noreferrer" >complaints about XFS</a> from Cloudflare.</p></li><li class="list__item" id="b4e74441_465"><p>Recently my colleague discovered that two of ClickHouse servers perform worse in a cluster than others and they found that they accidentally set up those servers with XFS instead of Ext4.</p></li><li class="list__item" id="b4e74441_466"><p>in the system journal you can sometimes see reports like 'task XYZ blocked for more than 120 seconds' and stack trace pointing to XFS code (example: https://gist.github.com/filimonov/85b894268f978c2ccc18ea69bae5adbd )</p></li><li class="list__item" id="b4e74441_467"><p>system goes to 99% io kernel under load sometimes.</p></li><li class="list__item" id="b4e74441_468"><p>we have XFS, sometimes clickhouse goes to &quot;sleep&quot; because XFS daemon is doing smth unknown</p></li></ul><p id="b4e74441_469">Maybe the above problem can be workaround by some tuning/settings, but so far we do not have a working and confirmed way to do this.</p></section><section class="chapter"><h3 id="zfs" data-toc="zfs"   >ZFS</h3><p id="b4e74441_470">Limitations exist, extra tuning may be needed, and having more RAM is recommended. Old kernels are not recommended.</p><p id="b4e74441_471">Memory usage control - ZFS adaptive replacement cache (ARC) can take a lot of RAM. It can be the reason of out-of-memory issues when memory is also requested by the ClickHouse.</p><ul class="list _ul" id="b4e74441_472"><li class="list__item" id="b4e74441_473"><p>It seems that the most important thing is zfs_arc_max - you just need to limit the maximum size of the ARC so that the sum of the maximum size of the arc + the CH itself does not exceed the size of the available RAM. For example, we set a limit of 80% RAM for Clickhouse and 10% for ARC. 10% will remain for the system and other applications</p></li></ul><p id="b4e74441_474">Tuning:</p><ul class="list _ul" id="b4e74441_475"><li class="list__item" id="b4e74441_476"><p>another potentially interesting setting is primarycache=metadata, see benchmark example: https://www.ikus-soft.com/en/blog/2018-05-23-proxmox-primarycache-all-metadata/</p></li><li class="list__item" id="b4e74441_477"><p>examples of tuning ZFS for MySQL https://wiki.freebsd.org/ZFSTuningGuide - perhaps some of this can also be useful (atime, recordsize) but everything needs to be carefully checked with benchmarks (I have no way).</p></li><li class="list__item" id="b4e74441_478"><p>best practices </p><ul class="list _ul" id="b4e74441_479"><li class="list__item" id="b4e74441_480"><p>https://efim360.ru/zfs-best-practices-guide/</p></li><li class="list__item" id="b4e74441_481"><p>https://pthree.org/2012/12/13/zfs-administration-part-viii-zpool-best-practices-and-caveats/</p></li></ul></li></ul><p id="b4e74441_482"><span class="control" id="b4e74441_483">important note</span>: ZFS does not support the <code class="code" id="b4e74441_484">renameat2</code> command, which is used by the Atomic database engine, and therefore some of the Atomic functionality will not be available.</p><p id="b4e74441_485">In old versions of clickhouse, you can face issues with the O_DIRECT mode.</p><p id="b4e74441_486">Also there is a well-known (and controversional) Linus Torvalds opinion: &quot;Don't Use ZFS on Linux&quot; <a href="https://www.realworldtech.com/forum/?threadid=189711&curpostid=189841" id="b4e74441_487"   data-external="true" rel="noopener noreferrer" >[1]</a>, <a href="https://arstechnica.com/gadgets/2020/01/linus-torvalds-zfs-statements-arent-right-heres-the-straight-dope/" id="b4e74441_488"   data-external="true" rel="noopener noreferrer" >[2]</a>, <a href="https://arstechnica.com/gadgets/2020/01/linus-torvalds-zfs-statements-arent-right-heres-the-straight-dope/" id="b4e74441_489"   data-external="true" rel="noopener noreferrer" >[3]</a>.</p></section><section class="chapter"><h3 id="btrfs" data-toc="btrfs"   >BTRFS</h3><p id="b4e74441_490">Not enough information. Some users <a href="https://github.com/ClickHouse/ClickHouse/issues/2743#issuecomment-517845388" id="b4e74441_491"   data-external="true" rel="noopener noreferrer" >report</a> performance improvement for their use case.</p></section><section class="chapter"><h3 id="reiserfs" data-toc="reiserfs"   >ReiserFS</h3><p id="b4e74441_492">Not enough information.</p></section><section class="chapter"><h3 id="lustre" data-toc="lustre"   >Lustre</h3><p id="b4e74441_493">There are reports that some people successfully use it in their setups. A fast network is required.</p><p id="b4e74441_494">There were some reports about data damage on the disks on older clickhouse versions, which could be caused by the issues with O_DIRECT or <a href="https://lustre-discuss.lustre.narkive.com/zwcvyEEY/asynchronous-posix-i-o-with-lustre" id="b4e74441_495"   data-external="true" rel="noopener noreferrer" >async io support</a> on Lustre.</p></section><section class="chapter"><h3 id="nfs-and-efs" data-toc="nfs-and-efs"   >NFS (and EFS)</h3><p id="b4e74441_496">Accouding to the reports - it works, throughput depends a lot on the network speed. IOPS / number of file operations per seconds can be super low (due to the locking mechanism).</p><p id="b4e74441_497">https://github.com/ClickHouse/ClickHouse/issues/31113</p></section><section class="chapter"><h3 id="moosefs" data-toc="moosefs"   >MooseFS</h3><p id="b4e74441_498">There are installations using that. No extra info.</p></section><section class="chapter"><h3 id="glusterfs" data-toc="glusterfs"   >GlusterFS</h3><p id="b4e74441_499">There are installations using that. No extra info.</p></section><section class="chapter"><h3 id="ceph" data-toc="ceph"   >Ceph</h3><p id="b4e74441_500">There are installations using that. Some information: https://github.com/ClickHouse/ClickHouse/issues/8315</p></section></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="high-cpu-usage.html">High CPU usage</a>   <a class="navigation-links__next" href="disk-encryption.html">Clickhouse data/disk encryption (at rest)</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>