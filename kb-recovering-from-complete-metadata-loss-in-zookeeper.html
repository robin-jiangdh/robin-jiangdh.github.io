<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:46.6983149"><meta name="build-number" content="${buildNumber}">       <title>Recovering from complete metadata loss in ZooKeeper | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"recovering-from-complete-metadata-loss-in-zookeeper-linktitle-recovering-from-complete-metadata-loss-in-zookeeper-description-recovering-from-complete-metadata-loss-in-zookeeper","level":0,"title":"#Recovering from complete metadata loss in ZooKeeper\nlinkTitle: \"Recovering from complete metadata loss in ZooKeeper\"\ndescription: \u003e\nRecovering from complete metadata loss in ZooKeeper","anchor":"#recovering-from-complete-metadata-loss-in-zookeeper-linktitle-recovering-from-complete-metadata-loss-in-zookeeper-description-recovering-from-complete-metadata-loss-in-zookeeper"},{"id":"problem","level":0,"title":"Problem","anchor":"#problem"},{"id":"test-case","level":0,"title":"Test case","anchor":"#test-case"},{"id":"current-solution","level":0,"title":"Current Solution","anchor":"#current-solution"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Recovering from complete metadata loss in ZooKeeper | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/kb-recovering-from-complete-metadata-loss-in-zookeeper.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Recovering from complete metadata loss in ZooKeeper | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/kb-recovering-from-complete-metadata-loss-in-zookeeper.html#webpage", "url": "/blog/1.0/kb-recovering-from-complete-metadata-loss-in-zookeeper.html", "name": "Recovering from complete metadata loss in ZooKeeper | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-recovering-from-complete-metadata-loss-in-zookeeper" data-main-title="Recovering from complete metadata loss in ZooKeeper" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance///kb-zookeeper"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-recovering-from-complete-metadata-loss-in-zookeeper"   id="kb-recovering-from-complete-metadata-loss-in-zookeeper.md">Recovering from complete metadata loss in ZooKeeper</h1>  <section class="chapter"><h2 id="recovering-from-complete-metadata-loss-in-zookeeper-linktitle-recovering-from-complete-metadata-loss-in-zookeeper-description-recovering-from-complete-metadata-loss-in-zookeeper" data-toc="recovering-from-complete-metadata-loss-in-zookeeper-linktitle-recovering-from-complete-metadata-loss-in-zookeeper-description-recovering-from-complete-metadata-loss-in-zookeeper"   >#Recovering from complete metadata loss in ZooKeeper
linkTitle: &quot;Recovering from complete metadata loss in ZooKeeper&quot;
description: &gt;
Recovering from complete metadata loss in ZooKeeper</h2></section><section class="chapter"><h2 id="problem" data-toc="problem"   >Problem</h2><p id="be11ab77_415">Every ClickHouse user experienced a loss of ZooKeeper one day. While the data is available and replicas respond to queries, inserts are no longer possible. ClickHouse uses ZooKeeper in order to store the reference version of the table structure and part of data, and when it is not available can not guarantee data consistency anymore. Replicated tables turn to the read-only mode. In this article we describe step-by-step instructions of how to restore ZooKeeper metadata and bring ClickHouse cluster back to normal operation.</p><p id="be11ab77_416">In order to restore ZooKeeper we have to solve two tasks. First, we need to restore table metadata in ZooKeeper. Currently, the only way to do it is to recreate the table with the <code class="code" id="be11ab77_417">CREATE TABLE DDL</code> statement.</p><div class="code-block" data-lang="none"         >
CREATE TABLE table_name ... ENGINE=ReplicatedMergeTree('zookeeper_path','replica_name');
</div><p id="be11ab77_419">The second and more difficult task is to populate zookeeper with information of clickhouse data parts. As mentioned above, ClickHouse stores the reference data about all parts of replicated tables in ZooKeeper, so we have to traverse all partitions and re-attach them to the recovered replicated table in order to fix that.</p><p id="be11ab77_420">Starting from ClickHouse version 21.7 there is SYSTEM RESTORE REPLICA command</p><p id="be11ab77_421"><a href="https://Robinjiang.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost" id="be11ab77_422"   data-external="true" rel="noopener noreferrer" >https://Robinjiang.com/blog/a-new-way-to-restore-clickhouse-after-zookeeper-metadata-is-lost</a></p></section><section class="chapter"><h2 id="test-case" data-toc="test-case"   >Test case</h2><p id="be11ab77_423">Let's say we have replicated table <code class="code" id="be11ab77_424">table_repl</code>.</p><div class="code-block" data-lang="none"         >
CREATE TABLE table_repl 
(
   `number` UInt32
)
ENGINE = ReplicatedMergeTree('/clickhouse/{cluster}/tables/{shard}/table_repl','{replica}')
PARTITION BY intDiv(number, 1000)
ORDER BY number;
</div><p id="be11ab77_426">And populate it with some data</p><div class="code-block" data-lang="none"         >
SELECT * FROM system.zookeeper WHERE path='/clickhouse/cluster_1/tables/01/';

INSERT INTO table_repl SELECT * FROM numbers(1000,2000);

SELECT partition, sum(rows) AS rows, count() FROM system.parts WHERE table='table_repl' AND active GROUP BY partition;
</div><p id="be11ab77_428">Now let&rsquo;s remove metadata in zookeeper using <code class="code" id="be11ab77_429">ZkCli.sh</code> at ZooKeeper host:</p><div class="code-block" data-lang="none"         >
deleteall  /clickhouse/cluster_1/tables/01/table_repl
</div><p id="be11ab77_431">And try to resync clickhouse replica state with zookeeper:</p><div class="code-block" data-lang="none"         >
SYSTEM RESTART REPLICA table_repl;
</div><p id="be11ab77_433">If we try to insert some data in the table, error happens:</p><div class="code-block" data-lang="none"         >
INSERT INTO table_repl SELECT number AS number FROM numbers(1000,2000) WHERE number % 2 = 0;
</div><p id="be11ab77_435">And now we have an exception that we lost all metadata in zookeeper. It is time to recover!</p></section><section class="chapter"><h2 id="current-solution" data-toc="current-solution"   >Current Solution</h2><ol class="list _decimal" id="be11ab77_436" type="1"><li class="list__item" id="be11ab77_437"><p id="be11ab77_438">Detach replicated table.</p><div class="code-block" data-lang="none"         >
DETACH TABLE table_repl;
</div></li><li class="list__item" id="be11ab77_440"><p id="be11ab77_441">Save the table&rsquo;s attach script and change engine of replicated table to non-replicated *mergetree analogue. Table definition is located in the &lsquo;metadata&rsquo; folder, &lsquo; <code class="code" id="be11ab77_442">/var/lib/clickhouse/metadata/default/table_repl.sql</code>&rsquo; in our example. Please make a backup copy and modify the file as follows:</p><div class="code-block" data-lang="none"         >
ATTACH TABLE table_repl
(
   `number` UInt32
)
ENGINE = ReplicatedMergeTree('/clickhouse/{cluster}/tables/{shard}/table_repl', '{replica}')
PARTITION BY intDiv(number, 1000)
ORDER BY number
SETTINGS index_granularity = 8192
</div><p id="be11ab77_444">Needs to be replaced with this:</p><div class="code-block" data-lang="none"         >
ATTACH TABLE table_repl
(
   `number` UInt32
)
ENGINE = MergeTree()
PARTITION BY intDiv(number, 1000)
ORDER BY number
SETTINGS index_granularity = 8192
</div></li><li class="list__item" id="be11ab77_446"><p id="be11ab77_447">Attach non-replicated table.</p><div class="code-block" data-lang="none"         >
ATTACH TABLE table_repl;
</div></li><li class="list__item" id="be11ab77_449"><p id="be11ab77_450">Rename non-replicated table.</p><div class="code-block" data-lang="none"         >
RENAME TABLE table_repl TO table_repl_old;
</div></li><li class="list__item" id="be11ab77_452"><p id="be11ab77_453">Create a new replicated table. Take the saved attach script and replace ATTACH with CREATE, and run it.</p><div class="code-block" data-lang="none"         >
CREATE TABLE table_repl
(
   `number` UInt32
)
ENGINE = ReplicatedMergeTree('/clickhouse/{cluster}/tables/{shard}/table_repl', '{replica}')
PARTITION BY intDiv(number, 1000)
ORDER BY number
SETTINGS index_granularity = 8192
</div></li><li class="list__item" id="be11ab77_455"><p id="be11ab77_456">Attach parts from old table to new.</p><div class="code-block" data-lang="none"         >
ALTER TABLE table_repl ATTACH PARTITION 1 FROM table_repl_old;

ALTER TABLE table_repl ATTACH PARTITION 2 FROM table_repl_old;
</div></li></ol><p id="be11ab77_458">If the table has many partitions, it may require some shell script to make it easier.</p><section class="chapter"><h3 id="automated-approach" data-toc="automated-approach"   >Automated approach</h3><p id="be11ab77_459">For a large number of tables, you can use script <a href="https://github.com/Robin/clickhouse-zookeeper-recovery" id="be11ab77_460"   data-external="true" rel="noopener noreferrer" >https://github.com/Robin/clickhouse-zookeeper-recovery</a> which partially automates the above approach.</p></section></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-zookeeper-backup.html">ZooKeeper backup</a>   <a class="navigation-links__next" href="kb-proper-setup.html">Proper setup</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>