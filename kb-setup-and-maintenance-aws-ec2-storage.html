<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:21.7458577"><meta name="build-number" content="${buildNumber}">       <title>AWS EC2 Storage | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"aws-ec2-storage-linktitle-aws-ec2-storage-description-aws-ebs-efs-fsx-lustre-aliases-kb-setup-and-maintenance-aws-ebs","level":0,"title":"#AWS EC2 Storage\nlinkTitle: \"AWS EC2 Storage\"\ndescription: \u003e\nAWS EBS, EFS, FSx, Lustre\naliases:\n- \"/kb-setup-and-maintenance/aws-ebs/\"","anchor":"#aws-ec2-storage-linktitle-aws-ec2-storage-description-aws-ebs-efs-fsx-lustre-aliases-kb-setup-and-maintenance-aws-ebs"},{"id":"general-purpose-ssd-volumes","level":0,"title":"General Purpose SSD volumes","anchor":"#general-purpose-ssd-volumes"},{"id":"throughput-optimized-hdd-volumes","level":0,"title":"Throughput Optimized HDD volumes","anchor":"#throughput-optimized-hdd-volumes"},{"id":"provisioned-iops-ssd-volumes","level":0,"title":"Provisioned IOPS SSD volumes","anchor":"#provisioned-iops-ssd-volumes"},{"id":"s3","level":0,"title":"S3","anchor":"#s3"},{"id":"efs","level":0,"title":"EFS","anchor":"#efs"},{"id":"fsx","level":0,"title":"FSx","anchor":"#fsx"},{"id":"lustre","level":0,"title":"Lustre","anchor":"#lustre"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="AWS EC2 Storage | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/kb-setup-and-maintenance-aws-ec2-storage.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="AWS EC2 Storage | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/kb-setup-and-maintenance-aws-ec2-storage.html#webpage", "url": "/1.0/kb-setup-and-maintenance-aws-ec2-storage.html", "name": "AWS EC2 Storage | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-setup-and-maintenance_aws-ec2-storage" data-main-title="AWS EC2 Storage" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-setup-and-maintenance_aws-ec2-storage"   id="kb-setup-and-maintenance_aws-ec2-storage.md">AWS EC2 Storage</h1>  <section class="chapter"><h2 id="aws-ec2-storage-linktitle-aws-ec2-storage-description-aws-ebs-efs-fsx-lustre-aliases-kb-setup-and-maintenance-aws-ebs" data-toc="aws-ec2-storage-linktitle-aws-ec2-storage-description-aws-ebs-efs-fsx-lustre-aliases-kb-setup-and-maintenance-aws-ebs"   >#AWS EC2 Storage
linkTitle: &quot;AWS EC2 Storage&quot;
description: &gt;
AWS EBS, EFS, FSx, Lustre
aliases:
- &quot;/kb-setup-and-maintenance/aws-ebs/&quot;</h2></section><p id="6a00b8c_609">Most native choose for ClickHouse as fast storage, because it usually guarantees best throughput, IOPS, latency for reasonable price.</p><p id="6a00b8c_610"><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html" id="6a00b8c_611"   data-external="true" rel="noopener noreferrer" >https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-optimized.html</a></p><p id="6a00b8c_612"><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html" id="6a00b8c_613"   data-external="true" rel="noopener noreferrer" >https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volume-types.html</a></p><section class="chapter"><h2 id="general-purpose-ssd-volumes" data-toc="general-purpose-ssd-volumes"   >General Purpose SSD volumes</h2><p id="6a00b8c_614">In usual conditions ClickHouse being limited by throughput of volumes and amount of provided IOPS doesn't make any big difference for performance starting from a certain number. So the most native choice for clickhouse is gp3 and gp2 volumes.</p><p id="6a00b8c_615">&zwnj;EC2 instances also have an EBS throughput limit, it depends on the size of the EC2 instance. That means if you would attach multiple volumes which would have high potential throughput, you would be limited by your EC2 instance, so usually there is no reason to have more than 1-3 GP3 volume or 4-5 GP2 volume per node.</p><p id="6a00b8c_616">It's pretty straightforward to set up a ClickHouse for using multiple EBS volumes with jbod storage_policies.</p><p id="6a00b8c_617"><a href="https://aws.amazon.com/ebs/general-purpose/" id="6a00b8c_618"   data-external="true" rel="noopener noreferrer" >general purpose</a></p><div class="table-wrapper"><table class="wide" id="6a00b8c_619"><thead><tr class="ijRowHead" id="6a00b8c_620"><th id="6a00b8c_621"><p><b id="6a00b8c_622">Volume type</b></p></th><th id="6a00b8c_623"><p>gp3</p></th><th id="6a00b8c_624"><p>gp2</p></th></tr></thead><tbody><tr id="6a00b8c_625"><td id="6a00b8c_626"><p><b id="6a00b8c_627">Max throughput per volume</b></p></td><td id="6a00b8c_628"><p>1000 MiB/s</p></td><td id="6a00b8c_629"><p>250 MiB/s</p></td></tr><tr id="6a00b8c_630"><td id="6a00b8c_631"><p><b id="6a00b8c_632">Price</b></p></td><td id="6a00b8c_633"><p id="6a00b8c_634">$0.08/GB-month</p><p id="6a00b8c_635">3,000 IOPS free and</p><p id="6a00b8c_636">$0.005/provisioned IOPS-month over 3,000;</p><p id="6a00b8c_637">125 MB/s free and</p><p id="6a00b8c_638">$0.04/provisioned MB/s-month over 125</p></td><td id="6a00b8c_639"><p>$0.10/GB-month</p></td></tr></tbody></table></div><section class="chapter"><h3 id="gp3" data-toc="gp3"   >GP3</h3><p id="6a00b8c_640">It's <span class="control" id="6a00b8c_641">recommended option</span>, as it allow you to have only one volume, for instances which have less than 10 Gbps EBS Bandwidth (nodes =&lt;32 VCPU usually) and still have maximum performance. For bigger instances, it make sense to look into option of having several GP3 volumes.</p><p id="6a00b8c_642">It's a new type of volume, which is 20% cheaper than gp2 per GB-month and has lower free throughput: only 125 MiB/s vs 250 MiB/s. But you can buy additional throughput and IOPS for volume. It also works better if most of your queries read only one or several parts, because in that case you are not being limited by performance of a single EBS disk, as parts can be located only on one disk at once.</p><p id="6a00b8c_643">Because, you need to have less GP3 volumes compared to GP2 option, it's suggested approach for now.</p><p id="6a00b8c_644">For best performance, it's suggested to buy:</p><ul class="list _ul" id="6a00b8c_645"><li class="list__item" id="6a00b8c_646"><p>7000 IOPS</p></li><li class="list__item" id="6a00b8c_647"><p>Throughput up to the limit of your EC2 instance (1000 MiB/s is safe option)</p></li></ul></section><section class="chapter"><h3 id="gp2" data-toc="gp2"   >GP2</h3><p id="6a00b8c_648">&zwnj;GP2 volumes have a hard limit of 250 MiB/s per volume (for volumes bigger than 334 GB), it usually makes sense to split one big volume in multiple smaller volumes larger than 334GB in order to have maximum possible throughput.</p></section></section><section class="chapter"><h2 id="throughput-optimized-hdd-volumes" data-toc="throughput-optimized-hdd-volumes"   >Throughput Optimized HDD volumes</h2><section class="chapter"><h3 id="st1" data-toc="st1"   >ST1</h3><p id="6a00b8c_649">Looks like a good candidate for cheap cold storage for old data with decent maximum throughput 500 MiB/s. But it achieved only for big volumes &gt;5 TiB.</p><p id="6a00b8c_650"><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/hdd-vols.html#EBSVolumeTypes_st1" id="6a00b8c_651"   data-external="true" rel="noopener noreferrer" >Throughput credits and burst performance</a></p></section></section><section class="chapter"><h2 id="provisioned-iops-ssd-volumes" data-toc="provisioned-iops-ssd-volumes"   >Provisioned IOPS SSD volumes</h2><section class="chapter"><h3 id="io2-block-express-io2-io1" data-toc="io2-block-express-io2-io1"   >IO2&nbsp;Block Express, IO2, IO1</h3><p id="6a00b8c_652">In 99.99% cases doesn't give any benefit for ClickHouse compared to GP3 option and perform worse because maximum throughput is limited to 500 MiB/s per volume if you buy less than 32 000 IOPS, which is really expensive (compared to other options) and unneded for ClickHouse. And if you have spare money, it's better to spend them on better EC2 instance.</p></section></section><section class="chapter"><h2 id="s3" data-toc="s3"   >S3</h2><p id="6a00b8c_653">Best option for cold data, it can give considerably good throughput and really good price, but latencies and IOPS much worse than EBS option. Another intresting point is, for EC2 instance throughput limit for EBS and S3 calculated separately, so if you access your data both from EBS and S3, you can get double throughput.</p><p id="6a00b8c_654">It's stated in AWS documentation, that S3 can fully utilize network capacity of EC2 instance. (up to 100 Gb/s) Latencies or (first-byte-out) estimated to be 100-200 milliseconds withing single region.</p><p id="6a00b8c_655">It also recommended to enable <a href="https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html#create-gateway-endpoint-s3" id="6a00b8c_656"   data-external="true" rel="noopener noreferrer" >gateway endpoint for s3</a>, it can push throughput even futher (up to 800 Gb/s)</p><p id="6a00b8c_657"><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/optimizing-performance.html" id="6a00b8c_658"   data-external="true" rel="noopener noreferrer" >S3 best practices</a></p></section><section class="chapter"><h2 id="efs" data-toc="efs"   >EFS</h2><p id="6a00b8c_659">Works over NFSv4.1 version. We have clients, which run their ClickHouse installations over NFS. It works considerabely well as cold storage, so it's recommended to have EBS disks for hot data. A fast network is required.</p><p id="6a00b8c_660">ClickHouse doesn't have any native option to reuse the same data on durable network disk via several replicas. You either need to store the same data twice or build custom tooling around ClickHouse and use it without Replicated*MergeTree tables.</p></section><section class="chapter"><h2 id="fsx" data-toc="fsx"   >FSx</h2></section><section class="chapter"><h2 id="lustre" data-toc="lustre"   >Lustre</h2><p id="6a00b8c_661">We have several clients, who use Lustre (some of them use AWS FSx Lustre, another is self managed Lustre) without any big issue. Fast network is requered. There were known problems with data damage on older versions caused by issues with O_DIRECT or <a href="https://lustre-discuss.lustre.narkive.com/zwcvyEEY/asynchronous-posix-i-o-with-lustre" id="6a00b8c_662"   data-external="true" rel="noopener noreferrer" >async IO</a> support on Lustre.</p><p id="6a00b8c_663">ClickHouse doesn't have any native option to reuse the same data on durable network disk via several replicas. You either need to store the same data twice or build custom tooling around ClickHouse and use it without Replicated*MergeTree tables.</p><p id="6a00b8c_664"><a href="https://Robinjiang.com/blog/2019/11/27/amplifying-clickhouse-capacity-with-multi-volume-storage-part-1" id="6a00b8c_665"   data-external="true" rel="noopener noreferrer" >https://Robinjiang.com/blog/2019/11/27/amplifying-clickhouse-capacity-with-multi-volume-storage-part-1</a></p><p id="6a00b8c_666"><a href="https://Robinjiang.com/blog/2019/11/29/amplifying-clickhouse-capacity-with-multi-volume-storage-part-2" id="6a00b8c_667"   data-external="true" rel="noopener noreferrer" >https://Robinjiang.com/blog/2019/11/29/amplifying-clickhouse-capacity-with-multi-volume-storage-part-2</a></p><p id="6a00b8c_668"><a href="https://calculator.aws/#/createCalculator/EBS?nc2=h_ql_pr_calc" id="6a00b8c_669"   data-external="true" rel="noopener noreferrer" >https://calculator.aws/#/createCalculator/EBS?nc2=h_ql_pr_calc</a></p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-setup-and-maintenance-cgroups-k8s.html">cgroups and kubernetes cloud providers</a>   <a class="navigation-links__next" href="kb-setup-and-maintenance-asynchronous-metrics-descr.html">Description of asynchronous_metrics</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>