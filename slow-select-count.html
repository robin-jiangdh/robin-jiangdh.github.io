<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:46.5856879"><meta name="build-number" content="${buildNumber}">       <title>Why is simple `SELECT count()` Slow in ClickHouse? | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"why-is-simple-select-count-slow-in-clickhouse-linktitle-slow-select-count-weight-100-description","level":0,"title":"#Why is simple SELECT count() Slow in ClickHouse?\nlinkTitle: \"Slow SELECT count()\"\nweight: 100\ndescription: \u003e-","anchor":"#why-is-simple-select-count-slow-in-clickhouse-linktitle-slow-select-count-weight-100-description"},{"id":"why-is-simple-select-count-slow-in-clickhouse","level":0,"title":"Why is simple SELECT count() Slow in ClickHouse?","anchor":"#why-is-simple-select-count-slow-in-clickhouse"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Why is simple `SELECT count()` Slow in ClickHouse? | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/slow-select-count.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Why is simple `SELECT count()` Slow in ClickHouse? | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/slow-select-count.html#webpage", "url": "/blog/1.0/slow-select-count.html", "name": "Why is simple `SELECT count()` Slow in ClickHouse? | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="slow_select_count" data-main-title="Why is simple `SELECT count()` Slow in ClickHouse?" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-queries-and-syntax"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="slow_select_count"   id="slow_select_count.md">Why is simple `SELECT count()` Slow in ClickHouse?</h1>  <section class="chapter"><h2 id="why-is-simple-select-count-slow-in-clickhouse-linktitle-slow-select-count-weight-100-description" data-toc="why-is-simple-select-count-slow-in-clickhouse-linktitle-slow-select-count-weight-100-description"   >#Why is simple SELECT count() Slow in ClickHouse?
linkTitle: &quot;Slow SELECT count()&quot;
weight: 100
description: &gt;-</h2></section><section class="chapter"><h2 id="why-is-simple-select-count-slow-in-clickhouse" data-toc="why-is-simple-select-count-slow-in-clickhouse"   >Why is simple SELECT count() Slow in ClickHouse?</h2><p id="1a0423b0_298">ClickHouse is a columnar database that provides excellent performance for analytical queries. However, in some cases, a simple count query can be slow. In this article, we'll explore the reasons why this can happen and how to optimize the query.</p><section class="chapter"><h3 id="three-strategies-for-counting-rows-in-clickhouse" data-toc="three-strategies-for-counting-rows-in-clickhouse"   >Three Strategies for Counting Rows in ClickHouse</h3><p id="1a0423b0_299">There are three ways to count rows in a table in ClickHouse:</p><ol class="list _decimal" id="1a0423b0_300" type="1"><li class="list__item" id="1a0423b0_301"><p id="1a0423b0_302"><code class="code" id="1a0423b0_303">optimize_trivial_count_query</code>: This strategy extracts the number of rows from the table metadata. It's the fastest and most efficient way to count rows, but it only works for simple count queries.</p></li><li class="list__item" id="1a0423b0_304"><p id="1a0423b0_305"><code class="code" id="1a0423b0_306">allow_experimental_projection_optimization</code>: This strategy uses a virtual projection called _minmax_count_projection to count rows. It's faster than scanning the table but slower than the trivial count query.</p></li><li class="list__item" id="1a0423b0_307"><p id="1a0423b0_308">Scanning the smallest column in the table and reading rows from that. This is the slowest strategy and is only used when the other two strategies can't be used.</p></li></ol></section><section class="chapter"><h3 id="why-does-clickhouse-sometimes-choose-the-slowest-counting-strategy" data-toc="why-does-clickhouse-sometimes-choose-the-slowest-counting-strategy"   >Why Does ClickHouse Sometimes Choose the Slowest Counting Strategy?</h3><p id="1a0423b0_309">In some cases, ClickHouse may choose the slowest counting strategy even when there are faster options available. Here are some possible reasons why this can happen:</p><ol class="list _decimal" id="1a0423b0_310" type="1"><li class="list__item" id="1a0423b0_311"><p id="1a0423b0_312">Row policies are used on the table: If row policies are used, ClickHouse needs to filter rows to give the proper count. You can check if row policies are used by selecting from system.row_policies.</p></li><li class="list__item" id="1a0423b0_313"><p id="1a0423b0_314">Experimental light-weight delete feature was used on the table: If the experimental light-weight delete feature was used, ClickHouse may use the slowest counting strategy. You can check this by looking into parts_columns for the column named _row_exists. To do this, run the following query:</p></li></ol><div class="code-block" data-lang="none"         >
SELECT DISTINCT database, table FROM system.parts_columns WHERE column = '_row_exists';
</div><p id="1a0423b0_316">You can also refer to this issue on GitHub for more information: https://github.com/ClickHouse/ClickHouse/issues/47930.</p><ol class="list _decimal" id="1a0423b0_317" type="1" start="3"><li class="list__item" id="1a0423b0_318"><p id="1a0423b0_319"><code class="code" id="1a0423b0_320">SELECT FINAL</code> or <code class="code" id="1a0423b0_321">final=1</code> setting is used.</p></li><li class="list__item" id="1a0423b0_322"><p id="1a0423b0_323"><code class="code" id="1a0423b0_324">max_parallel_replicas &gt; 1</code> is used.</p></li><li class="list__item" id="1a0423b0_325"><p id="1a0423b0_326">Sampling is used.</p></li><li class="list__item" id="1a0423b0_327"><p id="1a0423b0_328">Some other features like <code class="code" id="1a0423b0_329">allow_experimental_query_deduplication</code> or <code class="code" id="1a0423b0_330">empty_result_for_aggregation_by_empty_set</code> is used.</p></li></ol></section></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="state-and-merge-combinators.html">-State &amp; -Merge combinators</a>   <a class="navigation-links__next" href="simplestateif-or-ifstate-for-simple-aggregate-functions.html">Simple aggregate functions &amp; combinators</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>