<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:23.0051573"><meta name="build-number" content="${buildNumber}">       <title>Async INSERTs | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"async-inserts-linktitle-async-inserts-description-async-inserts","level":0,"title":"#Async INSERTs\nlinkTitle: \"Async INSERTs\"\ndescription: \u003e\nAsync INSERTs","anchor":"#async-inserts-linktitle-async-inserts-description-async-inserts"},{"id":"22-10-bugfixes-features","level":0,"title":"22.10+ bugfixes/features","anchor":"#22-10-bugfixes-features"},{"id":"to-improve-observability-introspection","level":0,"title":"To improve observability / introspection","anchor":"#to-improve-observability-introspection"},{"id":"metrics","level":0,"title":"Metrics","anchor":"#metrics"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Async INSERTs | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/async-inserts.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Async INSERTs | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/async-inserts.html#webpage", "url": "/1.0/async-inserts.html", "name": "Async INSERTs | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="async-inserts" data-main-title="Async INSERTs" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-queries-and-syntax"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="async-inserts"   id="async-inserts.md">Async INSERTs</h1>  <section class="chapter"><h2 id="async-inserts-linktitle-async-inserts-description-async-inserts" data-toc="async-inserts-linktitle-async-inserts-description-async-inserts"   >#Async INSERTs
linkTitle: &quot;Async INSERTs&quot;
description: &gt;
Async INSERTs</h2><p id="b6ce2fd_323">Async INSERTs is a ClickHouse feature tha enables batching data automatically and transparently on the server-side. Although async inserts work, they still have issues, but have been improved in latest versions. We recommend to batch at app/ingestor level because you will have more control and you decouple this responsibility from ClickHouse. Being said that here some insights about Async inserts you should now:</p><ul class="list _ul" id="b6ce2fd_324"><li class="list__item" id="b6ce2fd_325"><p>Async inserts give acknowledgment immediately after the data got inserted into the buffer (wait_for_async_insert = 0) or by default, after the data got written to a part after flushing from buffer (wait_for_async_insert = 1).</p></li><li class="list__item" id="b6ce2fd_326"><p>INSERT .. SELECT is NOT async insert.</p></li><li class="list__item" id="b6ce2fd_327"><p>Async inserts will do (idempotent) retries.</p></li><li class="list__item" id="b6ce2fd_328"><p>Async inserts can collect data for some offline remote clusters: Yandex self-driving cars were collecting the metrics data during the ride into ClickHouse installed on the car computer to a distributed table with Async inserts enabled, which were flushed to the cluster once the car was plugged to the network.</p></li><li class="list__item" id="b6ce2fd_329"><p>Async inserts can do batching, so multiple inserts can be squashed as a single insert (but in that case, retries are not idempotent anymore).</p></li><li class="list__item" id="b6ce2fd_330"><p>Async inserts can loose your data in case of sudden restart (no fsyncs by default).</p></li><li class="list__item" id="b6ce2fd_331"><p>Async inserted data becomes available for selects not immediately after acknowledgment.</p></li><li class="list__item" id="b6ce2fd_332"><p>Async inserts generally have more <code class="code" id="b6ce2fd_333">moving parts</code> there are some background threads monitoring new data to be sent and pushing it out.</p></li><li class="list__item" id="b6ce2fd_334"><p>Async inserts require extra monitoring from different system.tables (see <code class="code" id="b6ce2fd_335">system.part_log</code>, <code class="code" id="b6ce2fd_336">system.query_log</code> and <code class="code" id="b6ce2fd_337">system.asynchronous_inserts</code> for 22.8). Previously such queries didn't appear in the query log. Check: <a href="https://github.com/ClickHouse/ClickHouse/pull/33239" id="b6ce2fd_338"   data-external="true" rel="noopener noreferrer" >#33239</a>.</p></li><li class="list__item" id="b6ce2fd_339"><p>Important to use <code class="code" id="b6ce2fd_340">wait_for_async_insert = 1</code> because with any error you will loose data without knowing it. For example your table is read only -&gt; losing data, out of disk space -&gt; losing data, too many parts -&gt; losing data.</p></li></ul></section><section class="chapter"><h2 id="22-10-bugfixes-features" data-toc="22-10-bugfixes-features"   >22.10+ bugfixes/features</h2><ul class="list _ul" id="b6ce2fd_341"><li class="list__item" id="b6ce2fd_342"><p>Fixed bug which could lead to deadlock while using asynchronous inserts. See <a href="https://github.com/ClickHouse/ClickHouse/pull/43233" id="b6ce2fd_343"   data-external="true" rel="noopener noreferrer" >#43233</a>.</p></li><li class="list__item" id="b6ce2fd_344"><p>Async insert dedup: Support block deduplication for asynchronous inserts. Before this change, async inserts did not support deduplication, because multiple small inserts coexisted in one inserted batch. See <a href="https://github.com/ClickHouse/ClickHouse/issues/38075" id="b6ce2fd_345"   data-external="true" rel="noopener noreferrer" >#38075</a> and <a href="https://github.com/ClickHouse/ClickHouse/pull/43304" id="b6ce2fd_346"   data-external="true" rel="noopener noreferrer" >#43304</a>.</p></li><li class="list__item" id="b6ce2fd_347"><p>Added system table <code class="code" id="b6ce2fd_348">asynchronous_insert_log</code>. It contains information about asynchronous inserts (including results of queries in fire-and-forget mode. (with wait_for_async_insert=0)) for better introspection. See <a href="https://github.com/ClickHouse/ClickHouse/pull/42040" id="b6ce2fd_349"   data-external="true" rel="noopener noreferrer" >#42040</a>.</p></li><li class="list__item" id="b6ce2fd_350"><p>Support async inserts in clickhouse-client for queries with inlined data. See <a href="https://github.com/ClickHouse/ClickHouse/pull/34267" id="b6ce2fd_351"   data-external="true" rel="noopener noreferrer" >#34267</a>.</p></li></ul></section><section class="chapter"><h2 id="to-improve-observability-introspection" data-toc="to-improve-observability-introspection"   >To improve observability / introspection</h2><p id="b6ce2fd_352">It is not possible to relate <code class="code" id="b6ce2fd_353">part_log/query_id</code> column with <code class="code" id="b6ce2fd_354">asynchronous_insert_log/query_id</code> column. We need to use <code class="code" id="b6ce2fd_355">query_log/query_id</code>:</p><p id="b6ce2fd_356"><code class="code" id="b6ce2fd_357">asynchronous_insert_log</code> shows up the <code class="code" id="b6ce2fd_358">query_id</code> and <code class="code" id="b6ce2fd_359">flush_query_id</code> of each async insert. The <code class="code" id="b6ce2fd_360">query_id</code> from async insert shows up in the <code class="code" id="b6ce2fd_361">system.query_log</code> as <code class="code" id="b6ce2fd_362">type = 'QueryStart'</code> but the same <code class="code" id="b6ce2fd_363">query_id</code> does not show up in the <code class="code" id="b6ce2fd_364">query_id</code> column of the <code class="code" id="b6ce2fd_365">system.part_log</code>. Because the <code class="code" id="b6ce2fd_366">query_id</code> column in the <code class="code" id="b6ce2fd_367">part_log</code> is the identifier of the INSERT query that created a data part, and it seems it is for sync INSERTS but not for async inserts.</p></section><section class="chapter"><h2 id="metrics" data-toc="metrics"   >Metrics</h2><div class="code-block" data-lang="none"         >
SELECT *
FROM system.metrics
WHERE metric LIKE '%AsyncInsert%'

Query id: 7384b8c8-3d87-4059-b1c4-e9955e97232b

┌─metric───────────────┬─value─┬─description────────────────────────────────────────────────┐
│ PendingAsyncInsert   │     0 │ Number of asynchronous inserts that are waiting for flush. │
│ AsyncInsertCacheSize │     0 │ Number of async insert hash id in cache                    │
└──────────────────────┴───────┴────────────────────────────────────────────────────────────┘

2 rows in set. Elapsed: 0.001 sec.
</div></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="atomic-insert.html">Atomic insert</a>   <a class="navigation-links__next" href="array-functions-as-window.html">Using array functions to mimic window-functions alike behavior</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>