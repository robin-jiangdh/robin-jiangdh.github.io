<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.9196465"><meta name="build-number" content="${buildNumber}">       <title>Fetch Alter Table | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"fetch-alter-table-linktitle-fetch-alter-table-description-fetch-alter-table","level":0,"title":"#Fetch Alter Table\nlinkTitle: \"Fetch Alter Table\"\ndescription: \u003e\nFetch Alter Table","anchor":"#fetch-alter-table-linktitle-fetch-alter-table-description-fetch-alter-table"},{"id":"get-partitions-by-database-and-table","level":0,"title":"Get partitions by database and table:","anchor":"#get-partitions-by-database-and-table"},{"id":"fetch-the-partitions","level":0,"title":"Fetch the partitions:","anchor":"#fetch-the-partitions"},{"id":"detach-tables-and-delete-replicas","level":0,"title":"Detach tables and delete replicas:","anchor":"#detach-tables-and-delete-replicas"},{"id":"query-to-generate-all-the-ddl","level":0,"title":"Query to generate all the DDL:","anchor":"#query-to-generate-all-the-ddl"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Fetch Alter Table | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/fetch-alter-table.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Fetch Alter Table | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/fetch-alter-table.html#webpage", "url": "/blog/1.0/fetch-alter-table.html", "name": "Fetch Alter Table | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="fetch_alter_table" data-main-title="Fetch Alter Table" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance///kb-data-migration"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="fetch_alter_table"   id="fetch_alter_table.md">Fetch Alter Table</h1>  <section class="chapter"><h2 id="fetch-alter-table-linktitle-fetch-alter-table-description-fetch-alter-table" data-toc="fetch-alter-table-linktitle-fetch-alter-table-description-fetch-alter-table"   >#Fetch Alter Table
linkTitle: &quot;Fetch Alter Table&quot;
description: &gt;
Fetch Alter Table</h2></section><p id="ddf40b97_376">This is a detailed explanation on how to move data by fetching partitions or parts between replicas</p><section class="chapter"><h2 id="get-partitions-by-database-and-table" data-toc="get-partitions-by-database-and-table"   >Get partitions by database and table:</h2><div class="code-block" data-lang="none"         >
SELECT
    hostName() AS host,
    database,
    table
    partition_id,
    name as part_id
FROM cluster('{cluster}', system.parts)
WHERE database IN ('db1','db2' ... 'dbn') AND active
</div><p id="ddf40b97_378">This query will return all the partitions and parts stored in this node for the databases and their tables.</p></section><section class="chapter"><h2 id="fetch-the-partitions" data-toc="fetch-the-partitions"   >Fetch the partitions:</h2><p id="ddf40b97_379">Prior starting with the fetching process it is recommended to check the <code class="code" id="ddf40b97_380">system.detached_parts</code> table of the destination node. There is a chance that detached folders already contain some old parts, and you will have to remove them all before starting moving data. Otherwise you will attach those old parts together with the fetched parts. Also you could run into issues if there are detached folders with the same names as the ones you are fetching (not very probable, put possible). Simply delete the detached parts and continue with the process.</p><p id="ddf40b97_381">To fetch a partition:</p><div class="code-block" data-lang="none"         >
ALTER TABLE &lt;tablename&gt; FETCH PARTITION &lt;partition_id&gt; FROM '/clickhouse/{cluster}/tables/{shard}/{table}'
</div><p id="ddf40b97_383">The <code class="code" id="ddf40b97_384">FROM</code> path is from the zookeeper node and you have to specify the shard from you're <a href="https://clickhouse.com/docs/en/sql-reference/statements/alter/partition#alter_fetch-partition" id="ddf40b97_385"   data-external="true" rel="noopener noreferrer" >fetching the partition</a>. Next executing the DDL query:</p><div class="code-block" data-lang="none"         >
ALTER TABLE &lt;tablename&gt; ATTACH PARTITION &lt;partition_id&gt;
</div><p id="ddf40b97_387">will attach the partitions to a table. Again and because the process is manual, it is recommended to check that the fetched partitions are attached correctly and that there are no detached parts left. Check both <code class="code" id="ddf40b97_388">system.parts</code> and <code class="code" id="ddf40b97_389">system.detached_parts</code> tables.</p></section><section class="chapter"><h2 id="detach-tables-and-delete-replicas" data-toc="detach-tables-and-delete-replicas"   >Detach tables and delete replicas:</h2><p id="ddf40b97_390">If needed, after moving the data and checking that everything is sound, you can detach the tables and delete the replicas.</p><div class="code-block" data-lang="none"         >
-- Required for DROP REPLICA
DETACH TABLE &lt;table_name&gt;;  

-- This will remove everything from /table_path_in_z/replicas/replica_name
-- but not the data. You could reattach the table again and
-- restore the replica if needed. Get the zookeeper_path and replica_name from system.replicas

SYSTEM DROP REPLICA 'replica_name' FROM ZKPATH '/table_path_in_zk/';
</div></section><section class="chapter"><h2 id="query-to-generate-all-the-ddl" data-toc="query-to-generate-all-the-ddl"   >Query to generate all the DDL:</h2><p id="ddf40b97_392">With this query you can generate the DDL script that will do the fetch and attach operations for each table and partition.</p><div class="code-block" data-lang="none"         >
SELECT
    DISTINCT
    'alter table '||database||'.'||table||' FETCH PARTITION '''||partition_id||''' FROM '''||zookeeper_path||'''; '
    ||'alter table '||database||'.'||table||' ATTACH PARTITION '''||partition_id||''';'
FROM system.parts INNER JOIN system.replicas USING (database, table)
WHERE database IN ('db1','db2' ... 'dbn') AND active
</div><p id="ddf40b97_394">You could add an ORDER BY to manually make the list in the order you need, or use ORDER BY rand() to randomize it. You will then need to split the commands between the shards.</p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-data-migration-index.html">Data Migration</a>   <a class="navigation-links__next" href="distributed-table-cluster.html">Distributed table to Cluster</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>