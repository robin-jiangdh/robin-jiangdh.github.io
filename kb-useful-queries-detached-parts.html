<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T23:19:47.4501783"><meta name="build-number" content="${buildNumber}">       <title>Can detached parts be dropped? | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"can-detached-parts-be-dropped-linktitle-can-detached-parts-be-dropped-description-can-detached-parts-be-dropped","level":0,"title":"#Can detached parts be dropped?\nlinkTitle: \"Can detached parts be dropped?\"\ndescription: \u003e\nCan detached parts be dropped?","anchor":"#can-detached-parts-be-dropped-linktitle-can-detached-parts-be-dropped-description-can-detached-parts-be-dropped"},{"id":"see-also","level":0,"title":"See also","anchor":"#see-also"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Can detached parts be dropped? | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/blog/1.0/kb-useful-queries-detached-parts.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Can detached parts be dropped? | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/blog/1.0/kb-useful-queries-detached-parts.html#webpage", "url": "/blog/1.0/kb-useful-queries-detached-parts.html", "name": "Can detached parts be dropped? | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/blog/#website", "url": "/blog/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="kb-useful-queries_detached-parts" data-main-title="Can detached parts be dropped?" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-useful-queries"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="kb-useful-queries_detached-parts"   id="kb-useful-queries_detached-parts.md">Can detached parts be dropped?</h1>  <section class="chapter"><h2 id="can-detached-parts-be-dropped-linktitle-can-detached-parts-be-dropped-description-can-detached-parts-be-dropped" data-toc="can-detached-parts-be-dropped-linktitle-can-detached-parts-be-dropped-description-can-detached-parts-be-dropped"   >#Can detached parts be dropped?
linkTitle: &quot;Can detached parts be dropped?&quot;
description: &gt;
Can detached parts be dropped?</h2><p id="4ec938b3_127">Here is what different statuses mean:</p><ol class="list _decimal" id="4ec938b3_128" type="1"><li class="list__item" id="4ec938b3_129"><p>Parts are renamed to 'ignored' if they were found during ATTACH together with other, bigger parts that cover the same blocks of data, i.e. they were already merged into something else.</p></li><li class="list__item" id="4ec938b3_130"><p>parts are renamed to 'broken' if ClickHouse was not able to load data from the parts. There could be different reasons: some files are lost, checksums are not correct, etc.</p></li><li class="list__item" id="4ec938b3_131"><p>parts are renamed to 'unexpected' if they are present locally, but are not found in ZooKeeper, in case when an insert was not completed properly. The part is detached only if it's old enough (5 minutes), otherwise CH registers this part in ZooKeeper as a new part.</p></li><li class="list__item" id="4ec938b3_132"><p>parts are renamed to 'cloned' if ClickHouse have had some parts on local disk while repairing lost replica so already existed parts being renamed and put in detached directory. Controlled by setting <code class="code" id="4ec938b3_133">detach_old_local_parts_when_cloning_replica</code>.</p></li></ol><p id="4ec938b3_134">'Ignored' parts are safe to delete. 'Unexpected' and 'broken' should be investigated, but it might not be an easy thing to do, especially for older parts. If the <code class="code" id="4ec938b3_135">system.part_log table</code> is enabled you can find some information there. Otherwise you will need to look in <code class="code" id="4ec938b3_136">clickhouse-server.log</code> for what happened when the parts were detached. If there is another way you could confirm that there is no data loss in the affected tables, you could simply delete all detached parts.</p><p id="4ec938b3_137">Here is a query that can help with investigations. It looks for active parts containing the same data blocks that the detached parts:</p><div class="code-block" data-lang="none"         >
select *, 
       concat('alter table ',database,'.',table,' drop detached part ''',a.name,''' settings allow_drop_detached=1;') as drop
from system.detached_parts a
left asof join 
(SELECT database, table, partition_id, name, active, min_block_number, max_block_number
   FROM system.parts WHERE active
) b on a.database=b.database and a.table=b.table and a.partition_id=b.partition_id
   and a.max_block_number &lt;= b.max_block_number
order by table, min_block_number, max_block_number
</div><section class="chapter"><h3 id="other-reasons" data-toc="other-reasons"   >Other reasons</h3><div class="code-block" data-lang="none"         >
# rg forgetPartAndMoveToDetached --type cpp
# rg renameToDetached --type cpp
# rg makeCloneInDetached --type cpp
broken
unexpected
ignored
noquorum
merge-not-byte-identical
mutate-not-byte-identical
broken-on-start
clone
covered-by-broken
</div></section></section><section class="chapter"><h2 id="see-also" data-toc="see-also"   >See also</h2><p id="4ec938b3_140">Since 22.6 clickhouse can clean old detached files automtically See https://github.com/ClickHouse/ClickHouse/pull/37975/</p></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-useful-queries-ingestion-rate-part-log.html">Ingestion metrics from system.part_log</a>   <a class="navigation-links__next" href="kb-useful-queries-debug-hang.html">Debug hanging thing</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>