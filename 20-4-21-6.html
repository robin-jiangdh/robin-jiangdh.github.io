<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:23.4966726"><meta name="build-number" content="${buildNumber}">       <title>clickhouse-copier 20.4 - 21.6 | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"clickhouse-copier-20-4-21-6-linktitle-clickhouse-copier-20-4-21-6-description-clickhouse-copier-20-4-21-6","level":0,"title":"#clickhouse-copier 20.4 - 21.6\nlinkTitle: \"clickhouse-copier 20.4 - 21.6\"\ndescription: \u003e\nclickhouse-copier 20.4 - 21.6","anchor":"#clickhouse-copier-20-4-21-6-linktitle-clickhouse-copier-20-4-21-6-description-clickhouse-copier-20-4-21-6"},{"id":"the-process-is-as-follows","level":0,"title":"The process is as follows","anchor":"#the-process-is-as-follows"},{"id":"configuring-the-engine-of-the-target-table","level":0,"title":"Configuring the engine of the target table","anchor":"#configuring-the-engine-of-the-target-table"},{"id":"how-to-configure-the-number-of-chunks","level":0,"title":"How to configure the number of chunks","anchor":"#how-to-configure-the-number-of-chunks"},{"id":"how-to-monitor-the-status-of-running-tasks","level":0,"title":"How to monitor the status of running tasks","anchor":"#how-to-monitor-the-status-of-running-tasks"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="clickhouse-copier 20.4 - 21.6 | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/20-4-21-6.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="clickhouse-copier 20.4 - 21.6 | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/20-4-21-6.html#webpage", "url": "/1.0/20-4-21-6.html", "name": "clickhouse-copier 20.4 - 21.6 | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="20.4_21.6" data-main-title="clickhouse-copier 20.4 - 21.6" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-setup-and-maintenance///kb-data-migration///kb-clickhouse-copier"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="20.4_21.6"   id="20.4_21.6.md">clickhouse-copier 20.4 - 21.6</h1>  <section class="chapter"><h2 id="clickhouse-copier-20-4-21-6-linktitle-clickhouse-copier-20-4-21-6-description-clickhouse-copier-20-4-21-6" data-toc="clickhouse-copier-20-4-21-6-linktitle-clickhouse-copier-20-4-21-6-description-clickhouse-copier-20-4-21-6"   >#clickhouse-copier 20.4 - 21.6
linkTitle: &quot;clickhouse-copier 20.4 - 21.6&quot;
description: &gt;
clickhouse-copier 20.4 - 21.6</h2><p id="66f62a4d_372">Clickhouse-copier was created to move data between clusters. It runs simple <code class="code" id="66f62a4d_373">INSERT&hellip;SELECT</code> queries and can copy data between tables with different engine parameters and between clusters with different number of shards. In the task configuration file you need to describe the layout of the source and the target cluster, and list the tables that you need to copy. You can copy whole tables or specific partitions. Clickhouse-copier uses temporary distributed tables to select from the source cluster and insert into the target cluster.</p><p id="66f62a4d_374">The behavior of clickhouse-copier was changed in 20.4:</p><ul class="list _ul" id="66f62a4d_375"><li class="list__item" id="66f62a4d_376"><p>Now clickhouse-copier inserts data into intermediate tables, and after the insert finishes successfully clickhouse-copier attaches the completed partition into the target table. This allows for incremental data copying, because the data in the target table is intact during the process. <span class="control" id="66f62a4d_377">Important note:</span> ATTACH PARTITION respects the <code class="code" id="66f62a4d_378">max_partition_size_to_drop</code> limit. Make sure the <code class="code" id="66f62a4d_379">max_partition_size_to_drop</code> limit is big enough (or set to zero) in the destination cluster. If clickhouse-copier is unable to attach a partition because of the limit, it will proceed to the next partition, and it will drop the intermediate table when the task is finished (if the intermediate table is less than the <code class="code" id="66f62a4d_380">max_table_size_to_drop</code> limit). <span class="control" id="66f62a4d_381">Another important note:</span> ATTACH PARTITION is replicated. The attached partition will need to be downloaded by the other replicas. This can create significant network traffic between ClickHouse nodes. If an attach takes a long time, clickhouse-copier will log a timeout and will proceed to the next step.</p></li><li class="list__item" id="66f62a4d_382"><p>Now clickhouse-copier splits the source data into chunks and copies them one by one. This is useful for big source tables, when inserting one partition of data can take hours. If there is an error during the insert clickhouse-copier has to drop the whole partition and start again. The <code class="code" id="66f62a4d_383">number_of_splits</code> parameter lets you split your data into chunks so that in case of an exception clickhouse-copier has to re-insert only one chunk of the data.</p></li><li class="list__item" id="66f62a4d_384"><p>Now clickhouse-copier runs <code class="code" id="66f62a4d_385">OPTIMIZE target_table PARTITION ... DEDUPLICATE</code> for non-Replicated MergeTree tables. <span class="control" id="66f62a4d_386">Important note:</span> This is a very strange feature that can do more harm than good. We recommend to disable it by configuring the engine of the target table as Replicated in the task configuration file, and create the target tables manually if they are not supposed to be replicated. Intermediate tables are always created as plain MergeTree.</p></li></ul></section><section class="chapter"><h2 id="the-process-is-as-follows" data-toc="the-process-is-as-follows"   >The process is as follows</h2><ol class="list _decimal" id="66f62a4d_387" type="1"><li class="list__item" id="66f62a4d_388"><p>Process the configuration files.</p></li><li class="list__item" id="66f62a4d_389"><p>Discover the list of partitions if not provided in the config.</p></li><li class="list__item" id="66f62a4d_390"><p>Copy partitions one by one ** The metadata in ZooKeeper suggests the order described here.** </p><ol class="list _decimal" id="66f62a4d_391" type="1"><li class="list__item" id="66f62a4d_392"><p>Copy chunks of data one by one. </p><ol class="list _decimal" id="66f62a4d_393" type="1"><li class="list__item" id="66f62a4d_394"><p>Copy data from source shards one by one. </p><ol class="list _decimal" id="66f62a4d_395" type="1"><li class="list__item" id="66f62a4d_396"><p>Create intermediate tables on all shards of the target cluster.</p></li><li class="list__item" id="66f62a4d_397"><p>Check the status of the chunk in ZooKeeper.</p></li><li class="list__item" id="66f62a4d_398"><p>Drop the partition from the intermediate table if the previous attempt was interrupted.</p></li><li class="list__item" id="66f62a4d_399"><p>Insert the chunk of data into the intermediate tables.</p></li><li class="list__item" id="66f62a4d_400"><p>Mark the shard as completed in ZooKeeper</p></li></ol></li></ol></li><li class="list__item" id="66f62a4d_401"><p>Attach the chunks of the completed partition into the target table one by one </p><ol class="list _decimal" id="66f62a4d_402" type="1"><li class="list__item" id="66f62a4d_403"><p>Attach a chunk into the target table.</p></li><li class="list__item" id="66f62a4d_404"><p><span class="control" id="66f62a4d_405">non-Replicated:</span> Run OPTIMIZE target_table DEDUPLICATE for the partition on the target table.</p></li></ol></li></ol></li><li class="list__item" id="66f62a4d_406"><p>Drop intermediate tables (may not succeed if the tables are bigger than <code class="code" id="66f62a4d_407">max_table_size_to_drop</code>).</p></li></ol><p id="66f62a4d_408">If there are several workers running simultaneously, they will assign themselves to different source shards. If a worker was interrupted, another worker can be started to continue the task. The next worker will drop incomplete partitions and resume the copying.</p></section><section class="chapter"><h2 id="configuring-the-engine-of-the-target-table" data-toc="configuring-the-engine-of-the-target-table"   >Configuring the engine of the target table</h2><p id="66f62a4d_409">Clickhouse-copier uses the engine from the task configuration file for these purposes:</p><ul class="list _ul" id="66f62a4d_410"><li class="list__item" id="66f62a4d_411"><p>to create target and intermediate tables if they don&rsquo;t exist.</p></li><li class="list__item" id="66f62a4d_412"><p>PARTITION BY: to SELECT a partition of data from the source table, to ATTACH partitions into target tables, to DROP incomplete partitions from intermediate tables, to OPTIMIZE partitions after they are attached to the target.</p></li><li class="list__item" id="66f62a4d_413"><p>ORDER BY: to SELECT a chunk of data from the source table.</p></li></ul><p id="66f62a4d_414">Here is an example of SELECT that clickhouse-copier runs to get the sixth of ten chunks of data:</p><div class="code-block" data-lang="none"         >
WHERE (&lt;the PARTITION BY clause&gt; = (&lt;a value of the PARTITION BY expression&gt; AS partition_key))
  AND (cityHash64(&lt;the ORDER BY clause&gt;) % 10 = 6 )
</div><p id="66f62a4d_416">Clickhouse-copier does not support the old MergeTree format. However, you can create the intermediate tables manually with the same engine as the target tables (otherwise ATTACH will not work), and specify the engine in the task configuration file in the new format so that clickhouse-copier can parse it for SELECT, ATTACH PARTITION and DROP PARTITION queries.</p><p id="66f62a4d_417"><span class="control" id="66f62a4d_418">Important note</span>: always configure engine as Replicated to disable OPTIMIZE &hellip; DEDUPLICATE (unless you know why you need clickhouse-copier to run OPTIMIZE &hellip; DEDUPLICATE).</p></section><section class="chapter"><h2 id="how-to-configure-the-number-of-chunks" data-toc="how-to-configure-the-number-of-chunks"   >How to configure the number of chunks</h2><p id="66f62a4d_419">The default value for <code class="code" id="66f62a4d_420">number_of_splits</code> is 10. You can change this parameter in the <code class="code" id="66f62a4d_421">table</code> section of the task configuration file. We recommend setting it to 1 for smaller tables.</p><div class="code-block" data-lang="none"         >
&lt;cluster_push&gt;target_cluster&lt;/cluster_push&gt;
&lt;database_push&gt;target_database&lt;/database_push&gt;
&lt;table_push&gt;target_table&lt;/table_push&gt;
&lt;number_of_splits&gt;1&lt;/number_of_splits&gt;
&lt;engine&gt;Engine=Replicated...&lt;engine&gt;
</div></section><section class="chapter"><h2 id="how-to-monitor-the-status-of-running-tasks" data-toc="how-to-monitor-the-status-of-running-tasks"   >How to monitor the status of running tasks</h2><p id="66f62a4d_423">Clickhouse-copier uses ZooKeeper to keep track of the progress and to communicate between workers. Here is a list of queries that you can use to see what&rsquo;s happening.</p><div class="code-block" data-lang="none"         >
--task-path=/clickhouse/copier/task1

-- The task config
select * from system.zookeeper
where path='&lt;task-path&gt;'
name                        | ctime               | mtime           
----------------------------+---------------------+--------------------
description                 | 2021-03-22 13:15:48 | 2021-03-22 13:25:28
status                      | 2021-03-22 13:15:48 | 2021-03-22 13:25:28
task_active_workers_version | 2021-03-22 13:15:48 | 2021-03-22 20:32:09
tables                      | 2021-03-22 13:16:47 | 2021-03-22 13:16:47
task_active_workers         | 2021-03-22 13:15:48 | 2021-03-22 13:15:48


-- Status
select * from system.zookeeper
where path='&lt;task-path&gt;/status'


-- Running workers
select * from system.zookeeper
where path='&lt;task-path&gt;/task_active_workers'


-- The list of processed tables
select * from system.zookeeper
where path='&lt;task-path&gt;/tables'


-- The list of processed partitions
select * from system.zookeeper
where path='&lt;task-path&gt;/tables/&lt;table&gt;'
name   | ctime           
-------+--------------------
202103 | 2021-03-22 13:16:47
202102 | 2021-03-22 13:18:31
202101 | 2021-03-22 13:27:36
202012 | 2021-03-22 14:05:08


-- The status of a partition
select * from system.zookeeper
where path='&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;'
name           | ctime           
---------------+--------------------
piece_0        | 2021-03-22 13:18:31
attach_is_done | 2021-03-22 14:05:05


-- The status of a piece
select * from system.zookeeper
where path='&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N'
name                           | ctime           
-------------------------------+--------------------
shards                         | 2021-03-22 13:18:31
is_dirty                       | 2021-03-22 13:26:51
partition_piece_active_workers | 2021-03-22 13:26:54
clean_start                    | 2021-03-22 13:26:54


-- The status of source shards
select * from system.zookeeper
where path='&lt;task-path&gt;/tables/&lt;table&gt;/&lt;partition&gt;/piece_N/shards'
name | ctime               | mtime           
-----+---------------------+--------------------
1    | 2021-03-22 13:26:54 | 2021-03-22 14:05:05
</div></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="kb-clickhouse-copier-index.html">clickhouse-copier</a>   <a class="navigation-links__next" href="20-3-and-earlier.html">clickhouse-copier 20.3 and earlier</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>