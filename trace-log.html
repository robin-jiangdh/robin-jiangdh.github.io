<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-12-17T22:54:21.825127"><meta name="build-number" content="${buildNumber}">       <title>Collecting query execution flamegraphs using system.trace_log | blog</title><script id="virtual-toc-data" type="application/json">[{"id":"collecting-query-execution-flamegraphs-using-system-trace-log-linktitle-trace-log-weight-100-description-collecting-query-execution-flamegraph-using-trace-log","level":0,"title":"#Collecting query execution flamegraphs using system.trace_log\nlinkTitle: \"trace_log\"\nweight: 100\ndescription: \u003e-\nCollecting query execution flamegraph using trace_log","anchor":"#collecting-query-execution-flamegraphs-using-system-trace-log-linktitle-trace-log-weight-100-description-collecting-query-execution-flamegraph-using-trace-log"},{"id":"collecting-query-execution-flamegraph-using-system-trace-log","level":0,"title":"Collecting query execution flamegraph using system.trace_log","anchor":"#collecting-query-execution-flamegraph-using-system-trace-log"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Collecting query execution flamegraphs using system.trace_log | blog"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="blog Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="/1.0/trace-log.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Collecting query execution flamegraphs using system.trace_log | blog"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "/1.0/trace-log.html#webpage", "url": "/1.0/trace-log.html", "name": "Collecting query execution flamegraphs using system.trace_log | blog", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "blog Help" }</script><!-- End Schema.org --></head>      <body data-id="trace_log" data-main-title="Collecting query execution flamegraphs using system.trace_log" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="Clickhouse///kb-queries-and-syntax"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>blog 1.0 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="trace_log"   id="trace_log.md">Collecting query execution flamegraphs using system.trace_log</h1>  <section class="chapter"><h2 id="collecting-query-execution-flamegraphs-using-system-trace-log-linktitle-trace-log-weight-100-description-collecting-query-execution-flamegraph-using-trace-log" data-toc="collecting-query-execution-flamegraphs-using-system-trace-log-linktitle-trace-log-weight-100-description-collecting-query-execution-flamegraph-using-trace-log"   >#Collecting query execution flamegraphs using system.trace_log
linkTitle: &quot;trace_log&quot;
weight: 100
description: &gt;-
Collecting query execution flamegraph using trace_log</h2></section><section class="chapter"><h2 id="collecting-query-execution-flamegraph-using-system-trace-log" data-toc="collecting-query-execution-flamegraph-using-system-trace-log"   >Collecting query execution flamegraph using system.trace_log</h2><p id="c94191fc_155">ClickHouse has embedded functionality to analyze the details of query performance.</p><p id="c94191fc_156">It's <code class="code" id="c94191fc_157">system.trace_log</code> table.</p><p id="c94191fc_158">By default it collects information only about queries when runs longer than 1 sec (and collects stacktraces every second).</p><p id="c94191fc_159">You can adjust that per query using settings <code class="code" id="c94191fc_160">query_profiler_real_time_period_ns</code> &amp; <code class="code" id="c94191fc_161">query_profiler_cpu_time_period_ns</code>.</p><p id="c94191fc_162">Both works very similar (with desired interval dump the stacktraces of all the threads which execute the query). real timer - allows to 'see' the situtions when cpu was not working much, but time was spend for example on IO. cpu timer - allows to see the 'hot' points in calculations more accurately (skip the io time).</p><p id="c94191fc_163">Trying to collect stacktraces with a frequency higher than few KHz is usually not possible.</p><p id="c94191fc_164">To check where most of the RAM is used you can collect stacktraces during memory allocations / deallocation, by using the setting <code class="code" id="c94191fc_165">memory_profiler_sample_probability</code>.</p><section class="chapter"><h3 id="clickhouse-speedscope" data-toc="clickhouse-speedscope"   >clickhouse-speedscope</h3><div class="code-block" data-lang="none"         >
# install 
wget https://github.com/laplab/clickhouse-speedscope/archive/refs/heads/master.tar.gz -O clickhouse-speedscope.tar.gz
tar -xvzf clickhouse-speedscope.tar.gz
cd clickhouse-speedscope-master/
pip3 install -r requirements.txt
</div><p id="c94191fc_167">For debugging particular query:</p><div class="code-block" data-lang="none"         >
clickhouse-client 

SET query_profiler_cpu_time_period_ns=1000000; -- 1000 times per 'cpu' sec
-- or SET query_profiler_real_time_period_ns=2000000; -- 500 times per 'real' sec.
-- or SET memory_profiler_sample_probability=0.1; -- to debug the memory allocations

SELECT ... &lt;your select&gt;

SYSTEM FLUSH LOGS;

-- get the query_id from the clickhouse-client output or from system.query_log (also pay attention on query_id vs initial_query_id for distributed queries).
</div><p id="c94191fc_169">Now let's process that:</p><div class="code-block" data-lang="none"         >
python3 main.py &amp;  # start the proxy in background
python3 main.py --query-id 908952ee-71a8-48a4-84d5-f4db92d45a5d # process the stacktraces
fg # get the proxy from background 
Ctrl + C  # stop it.
</div><p id="c94191fc_171">To access ClickHouse with other username / password etc. - see the sources of https://github.com/laplab/clickhouse-speedscope/blob/master/main.py</p></section><section class="chapter"><h3 id="clickhouse-flamegraph" data-toc="clickhouse-flamegraph"   >clickhouse-flamegraph</h3><p id="c94191fc_172">Installation &amp; usage instructions: https://github.com/Slach/clickhouse-flamegraph</p></section><section class="chapter"><h3 id="pure-flamegraph-pl-examples" data-toc="pure-flamegraph-pl-examples"   >pure flamegraph.pl examples</h3><div class="code-block" data-lang="none"         >
git clone https://github.com/brendangregg/FlameGraph /opt/flamegraph

clickhouse-client -q &quot;SELECT  arrayStringConcat(arrayReverse(arrayMap(x -&gt; concat( addressToLine(x), '#', demangle(addressToSymbol(x)) ), trace)), ';') AS stack, count() AS samples FROM system.trace_log WHERE event_time &gt;= subtractMinutes(now(),10) GROUP BY trace FORMAT TabSeparated&quot; | /opt/flamegraph/flamegraph.pl &gt; flamegraph.svg

clickhouse-client -q &quot;SELECT  arrayStringConcat((arrayMap(x -&gt; concat(splitByChar('/', addressToLine(x))[-1], '#', demangle(addressToSymbol(x)) ), trace)), ';') AS stack, sum(abs(size)) AS samples FROM system.trace_log where trace_type = 'Memory' and event_date = today() group by trace order by samples desc FORMAT TabSeparated&quot; | /opt/flamegraph/flamegraph.pl &gt; allocs.svg
clickhouse-client -q &quot;SELECT  arrayStringConcat(arrayReverse(arrayMap(x -&gt; concat(splitByChar('/', addressToLine(x))[-1], '#', demangle(addressToSymbol(x)) ), trace)), ';') AS stack, count() AS samples FROM system.trace_log where trace_type = 'Memory' group by trace FORMAT TabSeparated SETTINGS allow_introspection_functions=1&quot; | /opt/flamegraph/flamegraph.pl &gt; ~/mem1.svg
</div></section><section class="chapter"><h3 id="similar-using-perf" data-toc="similar-using-perf"   >similar using perf</h3><div class="code-block" data-lang="none"         >
apt-get update -y 
apt-get install -y linux-tools-common linux-tools-generic linux-tools-`uname -r`git
apt-get install -y clickhouse-common-static-dbg clickhouse-common-dbg
mkdir -p /opt/flamegraph
git clone https://github.com/brendangregg/FlameGraph /opt/flamegraph

perf record -F 99 -p $(pidof clickhouse) -G
perf script &gt; /tmp/out.perf
/opt/flamegraph/stackcollapse-perf.pl /tmp/out.perf | /opt/flamegraph/flamegraph.pl &gt; /tmp/flamegraph.svg
</div></section><section class="chapter"><h3 id="also" data-toc="also"   >also</h3><p id="c94191fc_175">https://kb.Robinjiang.com/kb-queries-and-syntax/troubleshooting/#flamegraph</p><p id="c94191fc_176">https://github.com/samber/grafana-flamegraph-panel/pull/2</p></section></section><div class="last-modified"> Last modified: 17 十二月 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="troubleshooting.html">Troubleshooting</a>   <a class="navigation-links__next" href="top-n-and-remain.html">Top N &amp; Remain</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.6.6-b205/app.js"></script></body></html>